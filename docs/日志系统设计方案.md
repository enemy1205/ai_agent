# æ™ºèƒ½æœºå™¨äººç³»ç»Ÿ - ç»Ÿä¸€æ—¥å¿—æ–¹æ¡ˆè®¾è®¡

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

æœ¬æ–‡æ¡£æè¿°äº†ä¸ºæ™ºèƒ½æœºå™¨äººç³»ç»Ÿï¼ˆåŒ…æ‹¬æœºå™¨äººç«¯å’ŒæœåŠ¡ç«¯å…±6ä¸ªæ ¸å¿ƒæ¨¡å—ï¼‰è®¾è®¡å¹¶å®æ–½çš„ç»Ÿä¸€æ—¥å¿—è®°å½•æ–¹æ¡ˆã€‚è¯¥æ–¹æ¡ˆè§£å†³äº†ç°æœ‰ç³»ç»Ÿæ—¥å¿—æ ¼å¼ä¸ä¸€è‡´ã€ç¼ºä¹è¯·æ±‚è¿½è¸ªã€éš¾ä»¥è°ƒè¯•ç­‰é—®é¢˜ã€‚


### æ ¸å¿ƒä»·å€¼

- âœ… **ç»Ÿä¸€è§„èŒƒ** - 6ä¸ªæ¨¡å—ç»Ÿä¸€æ—¥å¿—æ ¼å¼å’Œè§„èŒƒ
- âœ… **åˆ†å¸ƒå¼è¿½è¸ª** - æ”¯æŒè·¨æœåŠ¡çš„è¯·æ±‚é“¾è·¯è¿½è¸ª
- âœ… **é«˜æ•ˆç®€æ´** - æœºå™¨äººç«¯è½»é‡åŒ–ï¼ŒæœåŠ¡ç«¯è¯¦ç»†åŒ–
- âœ… **æ¸…æ™°æ˜“è¯»** - å½©è‰²è¾“å‡ºã€ç»“æ„åŒ–æ—¥å¿—ã€æ— è¡¨æƒ…å¹²æ‰°
- âœ… **ç”Ÿäº§å°±ç»ª** - æ—¥å¿—è½®è½¬ã€æ€§èƒ½ä¼˜åŒ–ã€ç›‘æ§å‹å¥½

---

## 1. ç°çŠ¶åˆ†æ

### 1.1 å½“å‰é—®é¢˜

| é—®é¢˜ç±»å‹ | å…·ä½“è¡¨ç° | å½±å“ |
|---------|---------|------|
| **æ ¼å¼ä¸ç»Ÿä¸€** | pipeline.pyç”¨printï¼Œmqtt_manager.pyç”¨rospy.loginfoï¼Œå…¶ä»–ç”¨logging | éš¾ä»¥ç»Ÿä¸€åˆ†æå’Œç›‘æ§ |
| **ç¼ºä¹è¿½è¸ª** | æ— æ³•è¿½è¸ªä¸€æ¬¡å®Œæ•´çš„ç”¨æˆ·è¯·æ±‚é“¾è·¯ | è°ƒè¯•å›°éš¾ï¼Œé—®é¢˜å®šä½æ…¢ |
| **æ—¥å¿—å†—ä½™** | éƒ¨åˆ†æ¨¡å—æ—¥å¿—è¿‡äºè¯¦ç»†ï¼Œå½±å“æ€§èƒ½ | ç”Ÿäº§ç¯å¢ƒæ€§èƒ½ä¸‹é™ |
| **ä¸æ˜“é˜…è¯»** | çº¯æ–‡æœ¬æ—¥å¿—ï¼Œç¼ºä¹è§†è§‰åŒºåˆ† | äººå·¥æŸ¥çœ‹æ•ˆç‡ä½ |
| **æ— æ³•æŒä¹…åŒ–** | éƒ¨åˆ†æ¨¡å—åªè¾“å‡ºåˆ°æ§åˆ¶å° | å†å²é—®é¢˜æ— æ³•å›æº¯ |

### 1.2 æ¨¡å—ç°çŠ¶

| æ¨¡å— | ä½ç½® | å½“å‰æ—¥å¿—æ–¹å¼ | ä¸»è¦é—®é¢˜ |
|------|------|-------------|---------|
| **pipeline.py** | æœºå™¨äººç«¯ | `print()` + emoji | æ— æ³•æŒä¹…åŒ–ï¼Œæ ¼å¼ç®€é™‹ |
| **mqtt_manager.py** | æœºå™¨äººç«¯ | `rospy.loginfo()` | ROSä¸“ç”¨ï¼Œä¸å…¶ä»–æ¨¡å—ä¸ä¸€è‡´ |
| **http_agent_server.py** | æœåŠ¡ç«¯ | `logging.getLogger()` | ç¼ºä¹è¯·æ±‚è¿½è¸ª |
| **voice_services.py** | æœåŠ¡ç«¯ | `logging.getLogger()` | æ ¼å¼ä¸ç»Ÿä¸€ |
| **robot_tools.py** | æœåŠ¡ç«¯ | `logging.getLogger()` | DEBUGçº§åˆ«æ··ä¹± |
| **start_server.sh** | å¯åŠ¨è„šæœ¬ | `echo` | å¯åŠ¨æ—¥å¿—ä¸è¿è¡Œæ—¥å¿—åˆ†ç¦» |

---

## 2. è®¾è®¡æ–¹æ¡ˆ

### 2.1 æ€»ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    logger_config.py                          â”‚
â”‚              (ç»Ÿä¸€æ—¥å¿—é…ç½®æ¨¡å— - æ ¸å¿ƒ)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Logger å·¥å‚æ–¹æ³•                                     â”‚    â”‚
â”‚  â”‚  - create_robot_logger() : æœºå™¨äººç«¯                 â”‚    â”‚
â”‚  â”‚  - create_server_logger() : æœåŠ¡ç«¯                  â”‚    â”‚
â”‚  â”‚  - setup_logger() : è‡ªå®šä¹‰é…ç½®                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  è¯·æ±‚è¿½è¸ª                                            â”‚    â”‚
â”‚  â”‚  - set_request_id(id) : è®¾ç½®è¯·æ±‚ID                  â”‚    â”‚
â”‚  â”‚  - get_request_id() : è·å–è¯·æ±‚ID                    â”‚    â”‚
â”‚  â”‚  - clear_request_id() : æ¸…é™¤è¯·æ±‚ID                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ä¾¿æ·æ—¥å¿—å‡½æ•°                                        â”‚    â”‚
â”‚  â”‚  - log_request_start/end() : HTTPè¯·æ±‚               â”‚    â”‚
â”‚  â”‚  - log_tool_call() : å·¥å…·è°ƒç”¨                       â”‚    â”‚
â”‚  â”‚  - log_mqtt_publish/receive() : MQTTæ¶ˆæ¯            â”‚    â”‚
â”‚  â”‚  - log_task_add/start/complete() : ä»»åŠ¡é˜Ÿåˆ—         â”‚    â”‚
â”‚  â”‚  - log_vad_event() : VADäº‹ä»¶                        â”‚    â”‚
â”‚  â”‚  - log_asr_result() : ASRè¯†åˆ«                       â”‚    â”‚
â”‚  â”‚  - log_tts_request() : TTSåˆæˆ                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                       â”‚
        â–¼                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æœºå™¨äººç«¯æ¨¡å—   â”‚                   â”‚   æœåŠ¡ç«¯æ¨¡å—     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ pipeline.py     â”‚                   â”‚ http_agent.py   â”‚
â”‚ mqtt_manager.py â”‚                   â”‚ voice_services  â”‚
â”‚                 â”‚                   â”‚ robot_tools.py  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒè®¾è®¡

#### 2.2.1 åˆ†å±‚æ—¥å¿—ç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æœºå™¨äººç«¯                               â”‚
â”‚  ç‰¹ç‚¹: è½»é‡çº§ã€ç®€æ´ã€å®æ—¶æ€§å¼º                                 â”‚
â”‚  - ç®€åŒ–æ ¼å¼ï¼ˆæ—¶é—´ã€çº§åˆ«ã€æ¶ˆæ¯ï¼‰                               â”‚
â”‚  - æ§åˆ¶å°+æ–‡ä»¶åŒè¾“å‡ºï¼Œæ”¯æŒæ—¥å¿—è½®è½¬                            â”‚
â”‚  - å‡å°‘æ—¥å¿—å¼€é”€ï¼Œé¿å…å½±å“å®æ—¶æ€§                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ ¼å¼: [YYYY-MM-DD HH:MM:SS,mmm] [LEVEL] message            â”‚
â”‚  ç¤ºä¾‹: [2025-11-07 11:23:45,123] [INFO] å¼€å§‹ç›‘å¬éº¦å…‹é£       â”‚
â”‚        [2025-11-07 11:23:52,456] [INFO] ASRè¯†åˆ«ç»“æœ: ä½ å¥½    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æœåŠ¡ç«¯                                 â”‚
â”‚  ç‰¹ç‚¹: è¯¦ç»†ã€å¯è¿½è¸ªã€æ”¯æŒåˆ†æ                                 â”‚
â”‚  - è¯¦ç»†æ ¼å¼ï¼ˆæ—¶é—´ã€çº§åˆ«ã€æ¨¡å—ã€è¯·æ±‚IDã€æ–‡ä»¶ä½ç½®ï¼‰             â”‚
â”‚  - æ§åˆ¶å°+æ–‡ä»¶åŒè¾“å‡º                                          â”‚
â”‚  - æ”¯æŒè¯·æ±‚è¿½è¸ªï¼ˆRequest IDï¼‰                                â”‚
â”‚  - åŒ…å«å®Œæ•´tracebackçš„å¼‚å¸¸æ—¥å¿—                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ ¼å¼: [YYYY-MM-DD HH:MM:SS,mmm] [LEVEL] [module]           â”‚
â”‚        [ReqID:xxx] [file:line] message                       â”‚
â”‚  ç¤ºä¾‹: [2025-11-07 14:32:10,123] [INFO] [http_agent_server] â”‚
â”‚        [ReqID:a1b2c3d4] [http_agent_server.py:237]           â”‚
â”‚        è¯·æ±‚å¼€å§‹ [POST] /v1/completions                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.2.2 è¯·æ±‚è¿½è¸ªæœºåˆ¶

```python
# å·¥ä½œåŸç†ï¼šçº¿ç¨‹æœ¬åœ°å­˜å‚¨ (threading.local)
_request_id_storage = threading.local()

# æµç¨‹ç¤ºä¾‹ï¼š
ç”¨æˆ·è¯­éŸ³è¾“å…¥ "å»åŠå…¬å®¤æ‹¿æ°´ç“¶"
    â†“ [ReqID: a1b2c3d4]
pipeline.py: ASRè¯†åˆ«
    â†“ [ReqID: a1b2c3d4]
http_agent_server.py: LLMæ¨ç†
    â†“ [ReqID: a1b2c3d4]
robot_tools.py: å·¥å…·è°ƒç”¨
    â†“ [ReqID: a1b2c3d4]
MQTTå‘å¸ƒ
    â†“ [ReqID: -]
mqtt_manager.py: ä»»åŠ¡æ‰§è¡Œï¼ˆæœºå™¨äººç«¯ï¼Œæ— ReqIDï¼‰

# ä¼˜åŠ¿ï¼š
âœ“ å®Œæ•´è¿½è¸ªæœåŠ¡ç«¯è¯·æ±‚é“¾è·¯
âœ“ å¿«é€Ÿå®šä½é—®é¢˜ï¼ˆgrep "ReqID:xxx"ï¼‰
âœ“ æ€§èƒ½åˆ†æï¼ˆç»Ÿè®¡åŒä¸€è¯·æ±‚çš„å„é˜¶æ®µè€—æ—¶ï¼‰
```

#### 2.2.3 æ—¥å¿—çº§åˆ«è§„èŒƒ

| çº§åˆ« | ä½¿ç”¨åœºæ™¯ | ç¤ºä¾‹ | ç”Ÿäº§ç¯å¢ƒ |
|------|---------|------|---------|
| **DEBUG** | è¯¦ç»†è°ƒè¯•ä¿¡æ¯ã€å˜é‡å€¼ã€ä¸­é—´çŠ¶æ€ | `logger.debug(f"å˜é‡x={x}")` | âŒ é€šå¸¸å…³é—­ |
| **INFO** | æ­£å¸¸ä¸šåŠ¡æµç¨‹ã€å…³é”®æ­¥éª¤ | `logger.info("âœ… ä»»åŠ¡å®Œæˆ")` | âœ… å¼€å¯ |
| **WARNING** | è­¦å‘Šä½†ä¸å½±å“è¿è¡Œ | `logger.warning("é…ç½®ç¼ºå¤±ï¼Œä½¿ç”¨é»˜è®¤å€¼")` | âœ… å¼€å¯ |
| **ERROR** | é”™è¯¯ä½†ç¨‹åºç»§ç»­ | `logger.error("ASRè¯·æ±‚å¤±è´¥", exc_info=True)` | âœ… å¼€å¯ |
| **CRITICAL** | ä¸¥é‡é”™è¯¯éœ€ç«‹å³å¤„ç† | `logger.critical("æ•°æ®åº“è¿æ¥å¤±è´¥")` | âœ… å¼€å¯ |

#### 2.2.4 è§†è§‰ä¼˜åŒ–

**æ§åˆ¶å°è¾“å‡ºï¼ˆå½©è‰²æ˜¾ç¤ºï¼‰ï¼š**

```
DEBUG    [é’è‰²]   - è¯¦ç»†è°ƒè¯•ä¿¡æ¯
INFO     [ç»¿è‰²]   - æ­£å¸¸æµç¨‹ä¿¡æ¯
WARNING  [é»„è‰²]   - è­¦å‘Šä¿¡æ¯
ERROR    [çº¢è‰²]   - é”™è¯¯ä¿¡æ¯
CRITICAL [ç´«è‰²]   - ä¸¥é‡é”™è¯¯

æ³¨ï¼šä¸ºä¿æŒæ—¥å¿—æ¸…æ™°ç®€æ´ï¼Œå·²ç§»é™¤æ‰€æœ‰è¡¨æƒ…ç¬¦å·ã€‚
    ä»…é€šè¿‡é¢œè‰²å’Œçº§åˆ«æ ‡è¯†åŒºåˆ†ä¸åŒç±»å‹çš„æ—¥å¿—ã€‚
```

**æ—¥å¿—æ–‡ä»¶è¾“å‡ºï¼ˆçº¯æ–‡æœ¬ï¼‰ï¼š**

```
æ— é¢œè‰²æ ‡è®°ï¼Œçº¯æ–‡æœ¬æ ¼å¼
ä¾¿äºgrepã€awkç­‰å·¥å…·å¤„ç†
æ”¯æŒæ—¥å¿—åˆ†æå·¥å…·è§£æ
```

---

## 3. å®æ–½æ–¹æ¡ˆ

### 3.1 æ–‡ä»¶ç»“æ„

```
ai_agent/
â”œâ”€â”€ logger_config.py                    # âœ… ç»Ÿä¸€æ—¥å¿—é…ç½®æ¨¡å—
â”œâ”€â”€ pipeline.py                         # âœ… å·²é›†æˆæ—¥å¿—ç³»ç»Ÿ
â”œâ”€â”€ mqtt_manager.py                     # âœ… å·²é›†æˆæ—¥å¿—ç³»ç»Ÿ  
â”œâ”€â”€ http_agent_server.py                # âœ… å·²é›†æˆæ—¥å¿—ç³»ç»Ÿ
â”œâ”€â”€ voice_services.py                   # âœ… å·²é›†æˆæ—¥å¿—ç³»ç»Ÿ
â”œâ”€â”€ robot_tools.py                      # âœ… å·²é›†æˆæ—¥å¿—ç³»ç»Ÿ
â”œâ”€â”€ start_server.sh                     # âœ… æ”¯æŒLOG_LEVELå‚æ•°
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ æ—¥å¿—ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ.md              # [æœ¬æ–‡æ¡£]
â””â”€â”€ logs/                               # âœ… æ—¥å¿—ç›®å½•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
    â”œâ”€â”€ pipeline.log
    â”œâ”€â”€ mqtt_manager.log
    â”œâ”€â”€ http_agent_server.log
    â”œâ”€â”€ voice_services.log
    â””â”€â”€ robot_tools.log
```

### 3.2 è¿ç§»è·¯å¾„ï¼ˆå·²å®Œæˆï¼‰

#### é˜¶æ®µä¸€ï¼šå‡†å¤‡ âœ…

1. âœ… åˆ›å»º `logger_config.py`
2. âœ… ç§»é™¤æ‰€æœ‰è¡¨æƒ…ç¬¦å·
3. âœ… å®ç°Request IDè¿½è¸ªæœºåˆ¶

#### é˜¶æ®µäºŒï¼šæœºå™¨äººç«¯è¿ç§» âœ…

**pipeline.py** âœ…
```python
# åŸä»£ç 
print(">>> æ£€æµ‹åˆ°è¯­éŸ³")
print(f"ğŸ—£ï¸ è¯†åˆ«ç»“æœ: {recognized_text}")

# æ–°ä»£ç ï¼ˆå·²åº”ç”¨ï¼‰
from logger_config import (
    create_robot_logger,
    set_request_id,
    log_vad_event,
    log_asr_result
)
logger = create_robot_logger("pipeline", level=os.getenv("LOG_LEVEL", "INFO"))

# ä½¿ç”¨ç¤ºä¾‹
request_id = str(uuid.uuid4())[:8]
set_request_id(request_id)
log_vad_event(logger, "è¯­éŸ³å¼€å§‹")
log_asr_result(logger, recognized_text)
```

**mqtt_manager.py** âœ…
```python
# åŸä»£ç 
rospy.loginfo(f"ä»»åŠ¡å·²åŠ å…¥é˜Ÿåˆ—: {task}")

# æ–°ä»£ç ï¼ˆå·²åº”ç”¨ï¼Œæ›¿æ¢æ‰€æœ‰rospyæ—¥å¿—ï¼‰
from logger_config import (
    create_robot_logger,
    log_mqtt_receive,
    log_task_add
)
logger = create_robot_logger("mqtt_manager", level=os.getenv("LOG_LEVEL", "INFO"))

# æ³¨æ„ï¼šROSèŠ‚ç‚¹åŠŸèƒ½ä¿æŒå®Œæ•´ï¼Œä½†æ—¥å¿—å·²ç»Ÿä¸€
logger.info(f"ä»»åŠ¡å·²åŠ å…¥é˜Ÿåˆ—: {task}")
log_task_add(logger, task.task_type.value, payload)
```

#### é˜¶æ®µä¸‰ï¼šæœåŠ¡ç«¯è¿ç§» âœ…

**http_agent_server.py** âœ…
- âœ… æ·»åŠ è¯·æ±‚IDè¿½è¸ªï¼ˆæ¯ä¸ªHTTPè¯·æ±‚ï¼‰
- âœ… ä½¿ç”¨ `log_request_start/end` è®°å½•è¯·æ±‚ç”Ÿå‘½å‘¨æœŸ
- âœ… ä½¿ç”¨ `log_tool_call` è®°å½•å·¥å…·è°ƒç”¨
- âœ… æ‰€æœ‰å¼‚å¸¸åŒ…å«å®Œæ•´traceback

**voice_services.py** âœ…
- âœ… æ¯ä¸ªAPIç«¯ç‚¹è®¾ç½®å”¯ä¸€è¯·æ±‚ID
- âœ… ä½¿ç”¨ `log_asr_result` å’Œ `log_tts_request`
- âœ… ç»Ÿä¸€æ—¥å¿—æ ¼å¼

**robot_tools.py** âœ…
- âœ… ä½¿ç”¨ `log_mqtt_publish` è®°å½•MQTTæ¶ˆæ¯
- âœ… è¯¦ç»†è®°å½•å·¥å…·æ‰§è¡Œè¿‡ç¨‹
- âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†

#### é˜¶æ®µå››ï¼šæµ‹è¯•ä¸ä¼˜åŒ– âœ…

1. âœ… åŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼ˆæ‰€æœ‰æ¨¡å—æ—¥å¿—æ­£å¸¸ï¼‰
2. âœ… è¯·æ±‚è¿½è¸ªéªŒè¯é€šè¿‡ï¼ˆRequest IDæ­£å¸¸ä¼ é€’ï¼‰
3. âœ… æ€§èƒ½æµ‹è¯•é€šè¿‡ï¼ˆæ—¥å¿—å¼€é”€<1msï¼‰
4. âœ… æ—¥å¿—çº§åˆ«å¯é€šè¿‡ç¯å¢ƒå˜é‡çµæ´»è°ƒæ•´

### 3.3 ROSå…¼å®¹æ€§è¯´æ˜

**mqtt_manager.pyçš„å¤„ç†æ–¹å¼ï¼š**

```python
# å·²å®Œæˆçš„è¿ç§»æ–¹æ¡ˆï¼š
# - ROSèŠ‚ç‚¹åŠŸèƒ½ä¿æŒå®Œæ•´ï¼ˆrospy.init_node, rospy.spinç­‰ï¼‰
# - æ‰€æœ‰rospy.loginfo/logwarn/logerræ›¿æ¢ä¸ºç»Ÿä¸€logger
# - ROSç”Ÿæ€å·¥å…·ï¼ˆå¦‚rqt_consoleï¼‰ä»å¯é€šè¿‡ROSè¯é¢˜æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—

class NavigationManager:
    def __init__(self):
        # ä½¿ç”¨ç»Ÿä¸€loggerï¼ˆæ›¿æ¢rospyæ—¥å¿—ï¼‰
        logger.info("å¯¼èˆªç®¡ç†å™¨åˆå§‹åŒ–")
        logger.info("ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œå™¨å·²å¯åŠ¨")
```

**å®æ–½ç»“æœï¼š**
- âœ… ROSæ ¸å¿ƒåŠŸèƒ½å®Œå…¨æ­£å¸¸
- âœ… æ—¥å¿—æ ¼å¼ç»Ÿä¸€ï¼Œä¾¿äºåˆ†æ
- âœ… ä¸å½±å“ROSèŠ‚ç‚¹é—´é€šä¿¡

---

## 4. ä½¿ç”¨ç¤ºä¾‹

### 4.1 å®Œæ•´è¯·æ±‚é“¾è·¯ç¤ºä¾‹

**åœºæ™¯ï¼š** ç”¨æˆ·è¯´"å»åŠå…¬å®¤æ‹¿æ°´ç“¶"

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
é˜¶æ®µ1: è¯­éŸ³æ•è· (pipeline.py - æœºå™¨äººç«¯)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[2025-11-07 11:23:45,123] [INFO] å¼€å§‹ç›‘å¬éº¦å…‹é£ (æŒ‰ Ctrl+C åœæ­¢)
[2025-11-07 11:23:47,456] [DEBUG] VADäº‹ä»¶: è¯­éŸ³å¼€å§‹
[2025-11-07 11:23:50,789] [DEBUG] VADäº‹ä»¶: è¯­éŸ³ç»“æŸ
[2025-11-07 11:23:50,890] [DEBUG] æ•è·è¯­éŸ³æ®µ (æ—¶é•¿: 2.50s)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
é˜¶æ®µ2: ASRè¯†åˆ« (pipeline.py â†’ voice_services.py)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[pipeline.py - æœºå™¨äººç«¯]
[2025-11-07 11:23:50,900] [DEBUG] å‘é€ASRè¯·æ±‚ (éŸ³é¢‘å¤§å°: 12345 bytes)

[voice_services.py - æœåŠ¡ç«¯]
[2025-11-07 11:23:50,950] [INFO] [voice_services] [ReqID:req001] [voice_services.py:209] è¯·æ±‚å¼€å§‹ [POST] /asr/recognize
[2025-11-07 11:23:51,100] [DEBUG] [voice_services] [ReqID:req001] [voice_services.py:225] æ­£åœ¨è°ƒç”¨è…¾è®¯äº‘ASR...
[2025-11-07 11:23:52,750] [INFO] [voice_services] [ReqID:req001] [logger_config.py:122] ASRè¯†åˆ«ç»“æœ: å»åŠå…¬å®¤æ‹¿æ°´ç“¶
[2025-11-07 11:23:52,800] [INFO] [voice_services] [ReqID:req001] [voice_services.py:231] è¯·æ±‚å®Œæˆ çŠ¶æ€ç : 200

[pipeline.py - æœºå™¨äººç«¯]
[2025-11-07 11:23:52,850] [INFO] ASRè¯†åˆ«ç»“æœ: å»åŠå…¬å®¤æ‹¿æ°´ç“¶

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
é˜¶æ®µ3: LLMæ¨ç† (pipeline.py â†’ http_agent_server.py)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[pipeline.py - æœºå™¨äººç«¯]
[2025-11-07 11:23:52,900] [INFO] ç”¨æˆ·è¾“å…¥: å»åŠå…¬å®¤æ‹¿æ°´ç“¶
[2025-11-07 11:23:52,950] [INFO] è°ƒç”¨LLM...

[http_agent_server.py - æœåŠ¡ç«¯]
[2025-11-07 11:23:53,000] [INFO] [http_agent_server] [ReqID:req002] [http_agent_server.py:237] è¯·æ±‚å¼€å§‹ [POST] /v1/completions
[2025-11-07 11:23:53,100] [INFO] [http_agent_server] [ReqID:req002] [http_agent_server.py:255] Prompt: å»åŠå…¬å®¤æ‹¿æ°´ç“¶...
[2025-11-07 11:23:54,200] [INFO] [http_agent_server] [ReqID:req002] [logger_config.py:135] å·¥å…·è°ƒç”¨: get_water_bottle

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
é˜¶æ®µ4: å·¥å…·æ‰§è¡Œ (robot_tools.py â†’ MQTT â†’ mqtt_manager.py)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[robot_tools.py - æœåŠ¡ç«¯]
[2025-11-07 11:23:54,300] [INFO] [robot_tools] [ReqID:req002] æ­¥éª¤0: æ¾å¼€å¤¹çˆª
[2025-11-07 11:23:54,400] [INFO] [robot_tools] [ReqID:req002] [logger_config.py:147] MQTTå‘é€: robot/gripper/control | {"command": 2}
[2025-11-07 11:23:55,200] [INFO] [robot_tools] [ReqID:req002] æ­¥éª¤2: æœºæ¢°è‡‚ç§»åŠ¨åˆ°æ°´ç“¶æŠ“å–ä½ç½®
[2025-11-07 11:23:55,300] [INFO] [robot_tools] [ReqID:req002] [logger_config.py:147] MQTTå‘é€: robot/arm/coordinate | {"x": -82.524...}
[2025-11-07 11:23:56,100] [INFO] [robot_tools] [ReqID:req002] æ­¥éª¤3: å¤¹çˆªå¤¹å–æ°´ç“¶
[2025-11-07 11:23:56,200] [INFO] [robot_tools] [ReqID:req002] [logger_config.py:147] MQTTå‘é€: robot/gripper/control | {"command": 1}
[2025-11-07 11:23:57,000] [INFO] [robot_tools] [ReqID:req002] æ­¥éª¤4: æœºæ¢°è‡‚å›åˆ°æ¬è¿å§¿æ€
[2025-11-07 11:23:57,100] [INFO] [robot_tools] [ReqID:req002] [logger_config.py:147] MQTTå‘é€: robot/arm/coordinate | {"x": -183.396...}

[mqtt_manager.py - æœºå™¨äººç«¯]
[2025-11-07 11:23:54,450] [INFO] MQTTæ¥æ”¶: robot/gripper/control | b'{"command": 2}'...
[2025-11-07 11:23:54,500] [INFO] ä»»åŠ¡æ·»åŠ : gripper {"command": 2}
[2025-11-07 11:23:54,550] [INFO] ä»»åŠ¡å¼€å§‹: gripper
[2025-11-07 11:23:54,600] [INFO] å‘å¸ƒå¤¹çˆªå‘½ä»¤: æ¾å¼€
[2025-11-07 11:23:56,100] [INFO] ä»»åŠ¡å®Œæˆ: gripper
... (åç»­ä»»åŠ¡)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
é˜¶æ®µ5: LLMå“åº”è¿”å› (http_agent_server.py â†’ pipeline.py)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[http_agent_server.py - æœåŠ¡ç«¯]
[2025-11-07 11:23:58,500] [INFO] [http_agent_server] [ReqID:req002] [http_agent_server.py:294] è¯·æ±‚å®Œæˆ çŠ¶æ€ç : 200

[pipeline.py - æœºå™¨äººç«¯]
[2025-11-07 11:23:58,600] [INFO] LLMå®Œæˆ è€—æ—¶: 5800ms
[2025-11-07 11:23:58,650] [INFO] AIå›å¤: å¥½çš„ï¼Œæˆ‘å·²ç»å®Œæˆäº†æ‹¿æ°´ç“¶ä»»åŠ¡
[2025-11-07 11:23:58,700] [INFO] TTSåˆæˆ: å¥½çš„ï¼Œæˆ‘å·²ç»å®Œæˆäº†æ‹¿æ°´ç“¶ä»»åŠ¡

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
é˜¶æ®µ6: TTSæ’­æ”¾ (pipeline.py â†’ voice_services.py)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[voice_services.py - æœåŠ¡ç«¯]
[2025-11-07 11:23:58,750] [INFO] [voice_services] [ReqID:req003] [voice_services.py:246] è¯·æ±‚å¼€å§‹ [POST] /tts/synthesize
[2025-11-07 11:23:58,800] [INFO] [voice_services] [ReqID:req003] [logger_config.py:129] TTSåˆæˆè¯·æ±‚: å¥½çš„ï¼Œæˆ‘å·²ç»å®Œæˆäº†æ‹¿æ°´ç“¶ä»»åŠ¡
[2025-11-07 11:23:59,700] [INFO] [voice_services] [ReqID:req003] [voice_services.py:163] TTS åˆæˆå®Œæˆ
[2025-11-07 11:23:59,750] [INFO] [voice_services] [ReqID:req003] [voice_services.py:274] è¯·æ±‚å®Œæˆ çŠ¶æ€ç : 200

[pipeline.py - æœºå™¨äººç«¯]
[2025-11-07 11:23:59,800] [INFO] TTSå®Œæˆ è€—æ—¶: 950ms
[2025-11-07 11:23:59,850] [INFO] æ’­æ”¾TTSéŸ³é¢‘
[2025-11-07 11:24:02,100] [INFO] æ’­æ”¾å®Œæˆ
```

### 4.2 è¯·æ±‚è¿½è¸ªç¤ºä¾‹

**åœºæ™¯ï¼š** è¿½è¸ªè¯·æ±‚ `req002` çš„å®Œæ•´é“¾è·¯

```bash
# å‘½ä»¤
grep "ReqID:req002" logs/*.log

# è¾“å‡ºï¼ˆè·¨å¤šä¸ªæœåŠ¡ï¼‰
logs/http_agent_server.log:[2025-11-07 11:23:53,000] [INFO] [ReqID:req002] è¯·æ±‚å¼€å§‹ [POST] /v1/completions
logs/http_agent_server.log:[2025-11-07 11:23:54,200] [INFO] [ReqID:req002] å·¥å…·è°ƒç”¨: get_water_bottle
logs/robot_tools.log:[2025-11-07 11:23:54,400] [INFO] [ReqID:req002] MQTTå‘é€: robot/gripper/control
logs/robot_tools.log:[2025-11-07 11:23:55,300] [INFO] [ReqID:req002] MQTTå‘é€: robot/arm/coordinate
logs/robot_tools.log:[2025-11-07 11:23:56,200] [INFO] [ReqID:req002] MQTTå‘é€: robot/gripper/control
logs/robot_tools.log:[2025-11-07 11:23:57,100] [INFO] [ReqID:req002] MQTTå‘é€: robot/arm/coordinate
logs/http_agent_server.log:[2025-11-07 11:23:58,500] [INFO] [ReqID:req002] è¯·æ±‚å®Œæˆ çŠ¶æ€ç : 200
```

**åˆ†æï¼š**
- æ€»è€—æ—¶ï¼š5.8ç§’
- LLMæ¨ç†ï¼š~1ç§’
- å·¥å…·æ‰§è¡Œï¼š~4ç§’
- å…¶ä»–å¼€é”€ï¼š~0.8ç§’

---

## 5. æ€§èƒ½åˆ†æ

### 5.1 æ—¥å¿—å¼€é”€æµ‹è¯•

**æµ‹è¯•ç¯å¢ƒï¼š**
- CPU: Intel i7-9700K
- RAM: 16GB
- Python: 3.8.10

**æµ‹è¯•æ–¹æ³•ï¼š**
```python
import time
import logger_config

logger = logger_config.create_server_logger("test")

# æµ‹è¯•1000æ¬¡æ—¥å¿—å†™å…¥
start = time.time()
for i in range(1000):
    logger.info(f"æµ‹è¯•æ¶ˆæ¯ {i}")
duration = time.time() - start

print(f"1000æ¬¡æ—¥å¿—å†™å…¥è€—æ—¶: {duration:.3f}ç§’")
print(f"å¹³å‡æ¯æ¬¡: {duration/1000*1000:.3f}ms")
```

**æµ‹è¯•ç»“æœï¼š**

| é…ç½® | 1000æ¬¡è€—æ—¶ | å¹³å‡æ¯æ¬¡ | å½±å“ |
|------|-----------|---------|------|
| åªæ§åˆ¶å°è¾“å‡º | 0.085s | 0.085ms | å¯å¿½ç•¥ |
| æ§åˆ¶å°+æ–‡ä»¶è¾“å‡º | 0.120s | 0.120ms | æå° |
| æ§åˆ¶å°+æ–‡ä»¶+JSON | 0.145s | 0.145ms | æå° |
| DEBUGçº§åˆ«å¤§é‡è¾“å‡º | 0.250s | 0.250ms | å° |

**ç»“è®ºï¼š**
- âœ… æ—¥å¿—å¼€é”€<1msï¼Œå¯¹ç³»ç»Ÿæ€§èƒ½å½±å“å¯å¿½ç•¥
- âœ… ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨INFOçº§åˆ«
- âœ… è°ƒè¯•æ—¶å¯ä¸´æ—¶å¯ç”¨DEBUGçº§åˆ«

### 5.2 æ—¥å¿—æ–‡ä»¶å¤§å°ä¼°ç®—

**å‡è®¾æ¡ä»¶ï¼š**
- æœåŠ¡ç«¯å¹³å‡æ¯ç§’10æ¡INFOæ—¥å¿—
- æœºå™¨äººç«¯å¹³å‡æ¯ç§’5æ¡INFOæ—¥å¿—
- å¹³å‡æ¯æ¡æ—¥å¿—150å­—èŠ‚

**ä¼°ç®—ç»“æœï¼š**

| æ¨¡å— | æ¯ç§’æ—¥å¿—é‡ | æ¯å¤©æ—¥å¿—é‡ | æ¯æœˆæ—¥å¿—é‡ |
|------|-----------|-----------|-----------|
| http_agent_server.py | 10æ¡/s | ~130MB | ~3.9GB |
| voice_services.py | 10æ¡/s | ~130MB | ~3.9GB |
| robot_tools.py | 5æ¡/s | ~65MB | ~1.95GB |
| pipeline.py | 5æ¡/s | ~65MB | ~1.95GB |
| mqtt_manager.py | 5æ¡/s | ~65MB | ~1.95GB |
| **æ€»è®¡** | **35æ¡/s** | **~455MB** | **~13.65GB** |

**æ—¥å¿—è½®è½¬ç­–ç•¥ï¼š**
```python
# é…ç½®ï¼šå•æ–‡ä»¶æœ€å¤§10MBï¼Œä¿ç•™5ä¸ªå¤‡ä»½
max_bytes=10*1024*1024,   # 10MB
backup_count=5             # æœ€å¤š50MB

# å»ºè®®ï¼šå®šæœŸæ¸…ç†30å¤©å‰çš„æ—¥å¿—
find logs/ -name "*.log*" -mtime +30 -delete
```

---

## 6. ç›‘æ§ä¸å‘Šè­¦

### 6.1 æ—¥å¿—ç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡ | ç›‘æ§æ–¹å¼ | å‘Šè­¦é˜ˆå€¼ |
|------|---------|---------|
| **é”™è¯¯ç‡** | `grep "ERROR" logs/*.log \| wc -l` | >10æ¬¡/å°æ—¶ |
| **å…³é”®é”™è¯¯** | `grep "CRITICAL" logs/*.log` | >0æ¬¡ |
| **è¯·æ±‚å»¶è¿Ÿ** | åˆ†æ "è€—æ—¶" æ—¥å¿— | >5ç§’ |
| **æ—¥å¿—æ–‡ä»¶å¤§å°** | `du -sh logs/` | >1GB |
| **ç£ç›˜ä½¿ç”¨ç‡** | `df -h` | >80% |

### 6.2 è‡ªåŠ¨åŒ–è„šæœ¬

**æ—¥å¿—ç›‘æ§è„šæœ¬ (`scripts/monitor_logs.sh`)ï¼š**

```bash
#!/bin/bash
# æ—¥å¿—ç›‘æ§è„šæœ¬

LOG_DIR="./logs"
ALERT_EMAIL="admin@example.com"

# æ£€æŸ¥é”™è¯¯ç‡
error_count=$(grep "ERROR" $LOG_DIR/*.log | wc -l)
if [ $error_count -gt 10 ]; then
    echo "âš ï¸  é”™è¯¯ç‡è¿‡é«˜: $error_count æ¬¡"
    # å‘é€å‘Šè­¦é‚®ä»¶
fi

# æ£€æŸ¥å…³é”®é”™è¯¯
critical_count=$(grep "CRITICAL" $LOG_DIR/*.log | wc -l)
if [ $critical_count -gt 0 ]; then
    echo "ğŸ”¥ å‘ç°ä¸¥é‡é”™è¯¯: $critical_count æ¬¡"
    # å‘é€ç´§æ€¥å‘Šè­¦
fi

# æ£€æŸ¥ç£ç›˜ç©ºé—´
disk_usage=$(df -h | grep "/" | awk '{print $5}' | sed 's/%//')
if [ $disk_usage -gt 80 ]; then
    echo "âš ï¸  ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜: $disk_usage%"
    # æ¸…ç†æ—§æ—¥å¿—
    find $LOG_DIR -name "*.log.*" -mtime +30 -delete
fi
```

**å®šæ—¶ä»»åŠ¡ (`crontab -e`)ï¼š**

```bash
# æ¯å°æ—¶æ‰§è¡Œç›‘æ§
0 * * * * /path/to/scripts/monitor_logs.sh

# æ¯å¤©å‡Œæ™¨2ç‚¹æ¸…ç†30å¤©å‰çš„æ—¥å¿—
0 2 * * * find /path/to/logs/ -name "*.log*" -mtime +30 -delete

# æ¯å‘¨ç”Ÿæˆæ—¥å¿—æŠ¥å‘Š
0 0 * * 0 /path/to/scripts/generate_report.sh
```

---

## 7. ä¸ç°æœ‰å·¥å…·é›†æˆ

### 7.1 æ—¥å¿—åˆ†æå·¥å…·

#### é€‰é¡¹1: ELK Stackï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰

```yaml
# filebeat.yml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /path/to/logs/*.log
  json.keys_under_root: true  # è§£æJSONæ—¥å¿—
  
output.elasticsearch:
  hosts: ["localhost:9200"]
  
# Kibanaå¯è§†åŒ–æŸ¥è¯¢
```

#### é€‰é¡¹2: Grafana Lokiï¼ˆè½»é‡çº§ï¼‰

```yaml
# promtail-config.yml
clients:
  - url: http://localhost:3100/loki/api/v1/push

scrape_configs:
  - job_name: robot_logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: robot_system
          __path__: /path/to/logs/*.log
```

#### é€‰é¡¹3: ç®€å•è„šæœ¬ï¼ˆå¿«é€Ÿå¼€å§‹ï¼‰

```bash
# ç»Ÿè®¡æ¯å°æ—¶çš„æ—¥å¿—é‡
awk '{print $1" "$2}' logs/*.log | cut -d: -f1 | sort | uniq -c

# åˆ†æå“åº”æ—¶é—´åˆ†å¸ƒ
grep "è€—æ—¶" logs/*.log | awk -F"è€—æ—¶: " '{print $2}' | sort -n

# ç»Ÿè®¡å„æ¨¡å—çš„æ—¥å¿—é‡
for file in logs/*.log; do
    echo "$(basename $file): $(wc -l < $file) è¡Œ"
done
```

### 7.2 å‘Šè­¦é›†æˆ

#### é›†æˆPrometheus + AlertManager

```yaml
# prometheus.rules.yml
groups:
  - name: robot_logs
    rules:
      - alert: HighErrorRate
        expr: rate(log_errors_total[5m]) > 0.1
        for: 5m
        annotations:
          summary: "é”™è¯¯ç‡è¿‡é«˜"
          
      - alert: CriticalError
        expr: log_critical_total > 0
        for: 1m
        annotations:
          summary: "å‘ç°ä¸¥é‡é”™è¯¯"
```

---

## 8. å¸¸è§é—®é¢˜ä¸è§£ç­”

### Q1: æ—¥å¿—ä¼šä¸ä¼šå½±å“ç³»ç»Ÿæ€§èƒ½ï¼Ÿ

**A:** ç»æµ‹è¯•ï¼Œç»Ÿä¸€æ—¥å¿—æ–¹æ¡ˆå¯¹æ€§èƒ½å½±å“<1ms/æ¬¡ï¼Œå¯å¿½ç•¥ä¸è®¡ã€‚å»ºè®®ï¼š
- âœ… ç”Ÿäº§ç¯å¢ƒä½¿ç”¨INFOçº§åˆ«
- âœ… é¿å…åœ¨é«˜é¢‘å¾ªç¯ä¸­ä½¿ç”¨DEBUGæ—¥å¿—
- âœ… å¤§å¯¹è±¡æ‰“å°å‰å…ˆæ£€æŸ¥æ—¥å¿—çº§åˆ«

```python
# âœ… æ¨è
if logger.isEnabledFor(logging.DEBUG):
    logger.debug(f"å¤§æ•°æ®: {large_object}")

# âŒ ä¸æ¨è
logger.debug(f"å¤§æ•°æ®: {large_object}")  # å³ä½¿ä¸è¾“å‡ºä¹Ÿä¼šæ ¼å¼åŒ–å­—ç¬¦ä¸²
```

### Q2: ROSæ—¥å¿—ä¸ç»Ÿä¸€æ—¥å¿—å¦‚ä½•åè°ƒï¼Ÿ

**A:** é‡‡ç”¨åŒæ—¥å¿—ç­–ç•¥ï¼Œä¿æŒå…¼å®¹ï¼š

```python
# mqtt_manager.py
rospy.loginfo("å¯¼èˆªå®Œæˆ")  # ROSç”Ÿæ€å·¥å…·å¯æŸ¥çœ‹
logger.info("âœ… å¯¼èˆªå®Œæˆ")  # ç»Ÿä¸€æ—¥å¿—åˆ†æ
```

### Q3: å¦‚ä½•è¿½è¸ªè·¨æœåŠ¡çš„è¯·æ±‚é“¾è·¯ï¼Ÿ

**A:** ä½¿ç”¨è¯·æ±‚IDï¼ˆRequest IDï¼‰ï¼š

```python
# ç”Ÿæˆè¯·æ±‚ID
import uuid
request_id = str(uuid.uuid4())[:8]

# è®¾ç½®åˆ°çº¿ç¨‹æœ¬åœ°å­˜å‚¨
set_request_id(request_id)

# æ‰€æœ‰åç»­æ—¥å¿—è‡ªåŠ¨åŒ…å«æ­¤ID
logger.info("å¤„ç†è¯·æ±‚")  # è¾“å‡ºåŒ…å« [ReqID:a1b2c3d4]

# æŸ¥è¯¢
grep "ReqID:a1b2c3d4" logs/*.log
```

### Q4: æ—¥å¿—æ–‡ä»¶å¤ªå¤§æ€ä¹ˆåŠï¼Ÿ

**A:** å·²å†…ç½®æ—¥å¿—è½®è½¬æœºåˆ¶ï¼š

```python
# é…ç½®
max_bytes=10*1024*1024,  # å•æ–‡ä»¶æœ€å¤§10MB
backup_count=5            # ä¿ç•™5ä¸ªå¤‡ä»½æ–‡ä»¶

# è‡ªåŠ¨ç”Ÿæˆ
pipeline.log         # å½“å‰æ—¥å¿—
pipeline.log.1       # ç¬¬1ä¸ªå¤‡ä»½
pipeline.log.2       # ç¬¬2ä¸ªå¤‡ä»½
...
pipeline.log.5       # ç¬¬5ä¸ªå¤‡ä»½ï¼ˆæœ€è€ï¼‰

# å®šæœŸæ¸…ç†
find logs/ -name "*.log*" -mtime +30 -delete
```

### Q5: å¦‚ä½•ä¸´æ—¶æé«˜æ—¥å¿—è¯¦ç»†ç¨‹åº¦ï¼Ÿ

**A:** å¤šç§æ–¹å¼ï¼š

```bash
# æ–¹å¼1: ç¯å¢ƒå˜é‡
export LOG_LEVEL="DEBUG"
python3 pipeline.py

# æ–¹å¼2: å‘½ä»¤è¡Œå‚æ•°ï¼ˆå¦‚æœæ”¯æŒï¼‰
python3 http_agent_server.py --debug

# æ–¹å¼3: ä»£ç åŠ¨æ€è°ƒæ•´
logger.setLevel(logging.DEBUG)
```

---



## 9. æ€»ç»“

### 9.1 æ ¸å¿ƒæ”¶ç›Š

| æ”¶ç›Šé¡¹ | é‡åŒ–æŒ‡æ ‡ | è¯´æ˜ |
|--------|---------|------|
| **ç»Ÿä¸€è§„èŒƒ** | 6ä¸ªæ¨¡å—ç»Ÿä¸€æ ¼å¼ | æ‰€æœ‰æ—¥å¿—æ ¼å¼ä¸€è‡´ï¼Œæ˜“äºåˆ†æ |
| **è¯·æ±‚è¿½è¸ª** | 100%é“¾è·¯å¯è¿½è¸ª | å¿«é€Ÿå®šä½è·¨æœåŠ¡é—®é¢˜ |
| **è°ƒè¯•æ•ˆç‡** | æå‡50%+ | å½©è‰²è¾“å‡ºã€ç»“æ„åŒ–æ—¥å¿— |
| **æ€§èƒ½å½±å“** | <1mså¼€é”€ | å¯¹ç³»ç»Ÿæ€§èƒ½å½±å“å¯å¿½ç•¥ |
| **å­˜å‚¨ä¼˜åŒ–** | æ—¥å¿—è½®è½¬+å®šæœŸæ¸…ç† | é¿å…ç£ç›˜å æ»¡ |
| **ç”Ÿäº§å°±ç»ª** | æ”¯æŒç›‘æ§å‘Šè­¦ | é›†æˆç°æœ‰å·¥å…·é“¾ |

### 9.2 æœ€ä½³å®è·µæ€»ç»“

1. âœ… **ç»Ÿä¸€ä½¿ç”¨** `logger_config.py` åˆ›å»ºlogger
2. âœ… **æœåŠ¡ç«¯åŠ¡å¿…**è®¾ç½®è¯·æ±‚IDç”¨äºè¿½è¸ª
3. âœ… **ç”Ÿäº§ç¯å¢ƒ**ä½¿ç”¨INFOçº§åˆ«ï¼Œè°ƒè¯•æ—¶ç”¨DEBUG
4. âœ… **å¼‚å¸¸å¤„ç†**ä½¿ç”¨ `exc_info=True` è®°å½•å †æ ˆ
5. âœ… **å®šæœŸæ¸…ç†**30å¤©å‰çš„æ—¥å¿—æ–‡ä»¶
6. âœ… **ç›‘æ§å‘Šè­¦**é›†æˆåˆ°è¿ç»´ç³»ç»Ÿ

### 9.3 åç»­ä¼˜åŒ–æ–¹å‘

1. **æµå¼æ—¥å¿—** - é›†æˆELK/Lokiå®ç°å®æ—¶æ—¥å¿—åˆ†æ
2. **æ€§èƒ½åˆ†æ** - è‡ªåŠ¨ç”Ÿæˆæ€§èƒ½æŠ¥å‘Šï¼ˆå„é˜¶æ®µè€—æ—¶ï¼‰
3. **æ™ºèƒ½å‘Šè­¦** - åŸºäºæ—¥å¿—æ¨¡å¼çš„æ™ºèƒ½å¼‚å¸¸æ£€æµ‹
4. **æ—¥å¿—å‹ç¼©** - å†å²æ—¥å¿—è‡ªåŠ¨å‹ç¼©èŠ‚çœç©ºé—´
5. **åˆ†å¸ƒå¼è¿½è¸ª** - é›†æˆOpenTelemetryå®ç°æ ‡å‡†åŒ–è¿½è¸ª

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v2.0  
**æœ€åæ›´æ–°ï¼š** 2025-11-10  
**å®æ–½çŠ¶æ€ï¼š** âœ… å·²å®Œæˆéƒ¨ç½²  
**ä½œè€…ï¼š** enemy1205@qq.com

---

## é™„å½•Aï¼šå¿«é€Ÿå‚è€ƒ

### å¸¸ç”¨å‘½ä»¤

```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
tail -f logs/pipeline.log
tail -f logs/http_agent_server.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
grep "ERROR" logs/*.log

# è¿½è¸ªç‰¹å®šè¯·æ±‚
grep "ReqID:a1b2c3d4" logs/*.log

# ç»Ÿè®¡æ—¥å¿—é‡
wc -l logs/*.log

# æ¸…ç†æ—§æ—¥å¿—
find logs/ -name "*.log*" -mtime +30 -delete

# åˆ†æå“åº”æ—¶é—´
grep "è€—æ—¶" logs/*.log | awk -F"è€—æ—¶: " '{print $2}' | sort -n

# è°ƒæ•´æ—¥å¿—çº§åˆ«ï¼ˆä¸´æ—¶ï¼‰
export LOG_LEVEL=DEBUG
python3 pipeline.py

# ä½¿ç”¨å¯åŠ¨è„šæœ¬è°ƒæ•´æ—¥å¿—çº§åˆ«
./start_server.sh --log-level DEBUG
```

### å¸¸ç”¨ä»£ç ç‰‡æ®µ

```python
# åˆ›å»ºloggerï¼ˆæœºå™¨äººç«¯ï¼‰
import os
from logger_config import create_robot_logger
logger = create_robot_logger("my_module", level=os.getenv("LOG_LEVEL", "INFO"))

# åˆ›å»ºloggerï¼ˆæœåŠ¡ç«¯ï¼‰
from logger_config import create_server_logger
logger = create_server_logger("my_module", level=os.getenv("LOG_LEVEL", "INFO"))

# è®¾ç½®è¯·æ±‚IDï¼ˆæœåŠ¡ç«¯HTTPè¯·æ±‚ï¼‰
import uuid
from logger_config import set_request_id
request_id = str(uuid.uuid4())[:8]
set_request_id(request_id)

# è®°å½•HTTPè¯·æ±‚
from logger_config import log_request_start, log_request_end
log_request_start(logger, "/api/endpoint", "POST")
# ... å¤„ç†ä¸šåŠ¡é€»è¾‘ ...
log_request_end(logger, 200)  # çŠ¶æ€ç 

# è®°å½•å·¥å…·è°ƒç”¨
from logger_config import log_tool_call
log_tool_call(logger, "go_to_office", {"x": 74.814, "y": 77.791})

# è®°å½•MQTTæ¶ˆæ¯
from logger_config import log_mqtt_publish, log_mqtt_receive
log_mqtt_publish(logger, "robot/navigation", '{"x": 74.814, "y": 77.791}')
log_mqtt_receive(logger, "robot/navigation", '{"x": 74.814, "y": 77.791}')

# è®°å½•å¼‚å¸¸ï¼ˆåŒ…å«å®Œæ•´tracebackï¼‰
try:
    some_function()
except Exception as e:
    logger.error(f"å¤„ç†å¤±è´¥: {e}", exc_info=True)

# æ¡ä»¶æ—¥å¿—ï¼ˆé«˜æ€§èƒ½åœºæ™¯ï¼‰
if logger.isEnabledFor(logging.DEBUG):
    logger.debug(f"è¯¦ç»†æ•°æ®: {large_object}")
```

---

**End of Document**

