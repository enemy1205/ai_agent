# è¯­éŸ³æ§åˆ¶æ™ºèƒ½æœºå™¨äººç³»ç»Ÿ - æ—¥å¿—è§„èŒƒ

## 1. æ–‡æ¡£è¯´æ˜

### 1.1 ç›®çš„

æœ¬æ–‡æ¡£æ—¨åœ¨è§„èŒƒåŒ–ç³»ç»Ÿå†…æ‰€æœ‰æ¨¡å—çš„æ—¥å¿—è¾“å‡ºæ ‡å‡†ï¼Œç¡®ä¿ï¼š
- æ—¥å¿—æ ¼å¼ç»Ÿä¸€ã€ä¿¡æ¯å®Œæ•´ã€ä¾¿äºè¿½è¸ª
- é—®é¢˜æ’æŸ¥é«˜æ•ˆã€ç³»ç»Ÿç›‘æ§ä¾¿æ·
- æ—¥å¿—è®°å½•éµå¾ªæœ€ä½³å®è·µå’Œç†è®ºåŸåˆ™

### 1.2 é€‚ç”¨èŒƒå›´

- æœºå™¨äººç«¯ï¼špipeline.py, mqtt_manager.py
- æœåŠ¡ç«¯ï¼švoice_services.py, http_agent_server.py, robot_tools.py
- æ‰€æœ‰éœ€è¦è®°å½•æ—¥å¿—çš„æ¨¡å—å’Œç»„ä»¶

### 1.3 ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®è®¢å†…å®¹ | ä½œè€… |
|-----|------|---------|------|
| v1.0 | 2025-11-05 | åˆå§‹ç‰ˆæœ¬ | enemy1205@qq.com |
| v1.1 | 2025-11-19 | æ—¥å¿—æ¥å£åˆ†ç¦» | enemy1205@qq.com |
---

## 2. æ—¥å¿—è®°å½•ç†è®ºåŸºç¡€

### 2.1 æ—¥å¿—è®°å½•çš„ç›®çš„

æ—¥å¿—è®°å½•æ˜¯ç³»ç»Ÿè¿è¡ŒçŠ¶æ€çš„é‡è¦è®°å½•æ‰‹æ®µï¼Œä¸»è¦æœåŠ¡äºä»¥ä¸‹ç›®çš„ï¼š

1. **è°ƒè¯•ï¼ˆDebuggingï¼‰**
   - å¸®åŠ©å¼€å‘äººå‘˜å®šä½ä»£ç é—®é¢˜
   - è¿½è¸ªç¨‹åºæ‰§è¡Œæµç¨‹
   - åˆ†æå¼‚å¸¸å’Œé”™è¯¯åŸå› 

2. **é—®é¢˜å®šä½ï¼ˆTroubleshootingï¼‰**
   - å¿«é€Ÿå®šä½ç”Ÿäº§ç¯å¢ƒé—®é¢˜
   - åˆ†æç³»ç»Ÿå¼‚å¸¸è¡Œä¸º
   - è¿½è¸ªé”™è¯¯å‘ç”Ÿçš„ä¸Šä¸‹æ–‡

3. **ç›‘æ§å‘Šè­¦ï¼ˆMonitoring & Alertingï¼‰**
   - å®æ—¶ç›‘æ§ç³»ç»Ÿå¥åº·çŠ¶æ€
   - è§¦å‘å¼‚å¸¸å‘Šè­¦
   - æ”¯æŒè‡ªåŠ¨åŒ–è¿ç»´

4. **ç”¨æˆ·è¡Œä¸ºå®¡è®¡ï¼ˆAuditingï¼‰**
   - è®°å½•å…³é”®æ“ä½œè½¨è¿¹
   - æ”¯æŒå®‰å…¨å®¡è®¡
   - æ»¡è¶³åˆè§„è¦æ±‚

5. **æ€§èƒ½åˆ†æï¼ˆPerformance Analysisï¼‰**
   - åˆ†æç³»ç»Ÿæ€§èƒ½ç“¶é¢ˆ
   - ä¼˜åŒ–å…³é”®è·¯å¾„
   - ç»Ÿè®¡ä¸šåŠ¡æŒ‡æ ‡

### 2.2 æ—¥å¿—è®°å½•çš„æ—¶æœº

åœ¨ä»¥ä¸‹åœºæ™¯ä¸‹å¿…é¡»è®°å½•æ—¥å¿—ï¼š

1. **ä»£ç åˆå§‹åŒ–**
   - æœåŠ¡å¯åŠ¨/åœæ­¢
   - æ¨¡å—åŠ è½½/å¸è½½
   - é…ç½®åŠ è½½å®Œæˆ

2. **è¿›å…¥é€»è¾‘å…¥å£**
   - APIè¯·æ±‚æ¥æ”¶
   - ä»»åŠ¡å¼€å§‹æ‰§è¡Œ
   - å…³é”®ä¸šåŠ¡æµç¨‹å¼€å§‹

3. **æ•è·å¼‚å¸¸**
   - try-catchå—æ•è·å¼‚å¸¸
   - é”™è¯¯å¤„ç†é€»è¾‘
   - å¼‚å¸¸æ¢å¤æ“ä½œ

4. **ä¸šåŠ¡æµç¨‹é¢„æœŸä¸ç¬¦**
   - å‚æ•°æ ¡éªŒå¤±è´¥
   - ä¸šåŠ¡è§„åˆ™æ ¡éªŒå¤±è´¥
   - çŠ¶æ€è½¬æ¢å¼‚å¸¸

5. **ç³»ç»Ÿ/ä¸šåŠ¡æ ¸å¿ƒé€»è¾‘çš„å…³é”®åŠ¨ä½œ**
   - æ•°æ®æŒä¹…åŒ–æ“ä½œ
   - å…³é”®çŠ¶æ€å˜æ›´
   - é‡è¦å†³ç­–ç‚¹

6. **ç¬¬ä¸‰æ–¹æœåŠ¡è¿œç¨‹è°ƒç”¨**
   - å¤–éƒ¨APIè°ƒç”¨å‰/å
   - ç½‘ç»œè¯·æ±‚å‘é€/æ¥æ”¶
   - æœåŠ¡é—´é€šä¿¡

### 2.3 æ—¥å¿—è®°å½•çš„åŸºæœ¬åŸåˆ™

#### 2.3.1 éš”ç¦»æ€§ï¼ˆIsolationï¼‰

**åŸåˆ™ï¼š** æ—¥å¿—è¾“å‡ºä¸èƒ½å½±å“ç³»ç»Ÿæ­£å¸¸è¿è¡Œã€‚

**å…·ä½“è¦æ±‚ï¼š**
- æ—¥å¿—è®°å½•æ“ä½œåº”è¯¥æ˜¯å¼‚æ­¥çš„æˆ–éé˜»å¡çš„
- æ—¥å¿—å†™å…¥å¤±è´¥ä¸åº”å¯¼è‡´ä¸šåŠ¡é€»è¾‘å¤±è´¥
- é¿å…åœ¨é«˜é¢‘å¾ªç¯ä¸­è¿›è¡Œå¤§é‡æ—¥å¿—è¾“å‡º
- æ—¥å¿—ç³»ç»Ÿæ•…éšœä¸åº”å½±å“ä¸»ä¸šåŠ¡åŠŸèƒ½

**ç¤ºä¾‹ï¼š**
```python
# æ­£ç¡®ï¼šä½¿ç”¨å¼‚æ­¥æ—¥å¿—æˆ–ç¡®ä¿æ—¥å¿—æ“ä½œå¿«é€Ÿå®Œæˆ
logger.info("å¤„ç†è¯·æ±‚", extra={"request_id": request_id})

# é”™è¯¯ï¼šåœ¨å…³é”®è·¯å¾„ä¸Šè¿›è¡Œè€—æ—¶æ—¥å¿—æ“ä½œ
logger.info(f"è¯¦ç»†æ•°æ®: {json.dumps(large_data)}")  # å¯èƒ½é˜»å¡
```

#### 2.3.2 å®‰å…¨æ€§ï¼ˆSecurityï¼‰

**åŸåˆ™ï¼š** æ—¥å¿—æ‰“å°æœ¬èº«ä¸èƒ½å­˜åœ¨é€»è¾‘å¼‚å¸¸æˆ–æ¼æ´ï¼Œå¯¼è‡´äº§ç”Ÿå®‰å…¨é—®é¢˜ã€‚

**å…·ä½“è¦æ±‚ï¼š**
- é¿å…æ—¥å¿—æ³¨å…¥æ”»å‡»ï¼ˆLog Injectionï¼‰
- é˜²æ­¢æ—¥å¿—ç³»ç»Ÿè¢«æ¶æ„åˆ©ç”¨
- æ—¥å¿—è®°å½•ä»£ç æœ¬èº«è¦å¥å£®
- é¿å…åœ¨æ—¥å¿—ä¸­æ‰§è¡Œå±é™©æ“ä½œ

**ç¤ºä¾‹ï¼š**
```python
# æ­£ç¡®ï¼šå¯¹ç”¨æˆ·è¾“å…¥è¿›è¡Œè½¬ä¹‰
logger.info(f"ç”¨æˆ·è¾“å…¥: {escape(user_input)}")

# é”™è¯¯ï¼šç›´æ¥è®°å½•æœªéªŒè¯çš„ç”¨æˆ·è¾“å…¥
logger.info(f"æ‰§è¡Œå‘½ä»¤: {user_input}")  # å¯èƒ½å­˜åœ¨æ³¨å…¥é£é™©
```

#### 2.3.3 æ•°æ®å®‰å…¨ï¼ˆData Securityï¼‰

**åŸåˆ™ï¼š** ä¸å…è®¸è¾“å‡ºæœºå¯†ã€æ•æ„Ÿä¿¡æ¯ã€‚

**ç¦æ­¢è®°å½•çš„ä¿¡æ¯ç±»å‹ï¼š**
- ç”¨æˆ·å¯†ç ã€Tokenã€APIå¯†é’¥
- èº«ä»½è¯å·ç ã€é“¶è¡Œå¡å·
- ç”¨æˆ·è”ç³»æ–¹å¼ï¼ˆæ‰‹æœºå·ã€é‚®ç®±ï¼‰
- æ•æ„Ÿä¸šåŠ¡æ•°æ®
- å†…éƒ¨ç³»ç»Ÿé…ç½®ä¿¡æ¯

**å¤„ç†æ–¹å¼ï¼š**
- æ•æ„Ÿä¿¡æ¯ä½¿ç”¨å ä½ç¬¦æ›¿ä»£ï¼ˆå¦‚ï¼š`****`ï¼‰
- å¯¹æ•æ„Ÿå­—æ®µè¿›è¡Œè„±æ•å¤„ç†
- è®°å½•æ‘˜è¦ä¿¡æ¯è€Œéå®Œæ•´æ•°æ®

**ç¤ºä¾‹ï¼š**
```python
# æ­£ç¡®ï¼šè„±æ•å¤„ç†
logger.info(f"ç”¨æˆ·ç™»å½•: user_id={user_id}, phone=****{phone[-4:]}")

# é”™è¯¯ï¼šè®°å½•å®Œæ•´æ•æ„Ÿä¿¡æ¯
logger.info(f"ç”¨æˆ·ç™»å½•: user_id={user_id}, phone={phone}, token={token}")
```

#### 2.3.4 å¯ç›‘æ§åˆ†æï¼ˆMonitorableï¼‰

**åŸåˆ™ï¼š** æ—¥å¿—å¯ä»¥æä¾›ç»™ç›‘æ§ç³»ç»Ÿè¿›è¡Œç›‘æ§å’Œåˆ†æã€‚

**å…·ä½“è¦æ±‚ï¼š**
- ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—æ ¼å¼ï¼ˆæ¨èJSONï¼‰
- åŒ…å«å¯è¢«ç›‘æ§ç³»ç»Ÿè¯†åˆ«çš„å­—æ®µ
- å…³é”®æŒ‡æ ‡æ˜“äºæå–å’Œç»Ÿè®¡
- æ”¯æŒæ—¥å¿—èšåˆå’Œåˆ†æå·¥å…·

**ç¤ºä¾‹ï¼š**
```python
# æ­£ç¡®ï¼šç»“æ„åŒ–æ—¥å¿—
logger.info("APIè¯·æ±‚", extra={
    "method": "POST",
    "endpoint": "/api/users",
    "status_code": 200,
    "duration_ms": 150,
    "request_id": request_id
})

# é”™è¯¯ï¼šéç»“æ„åŒ–æ—¥å¿—
logger.info(f"POST /api/users 200 150ms {request_id}")
```

#### 2.3.5 å¯å®šä½æ’æŸ¥ï¼ˆTraceableï¼‰

**åŸåˆ™ï¼š** æ—¥å¿—ä¿¡æ¯è¾“å‡ºéœ€æœ‰æ„ä¹‰ï¼Œéœ€å…·æœ‰å¯è¯»æ€§ï¼Œå¯ä¾›æ—¥å¸¸å¼€å‘åŒå­¦æ’æŸ¥çº¿ä¸Šé—®é¢˜ã€‚

**å…·ä½“è¦æ±‚ï¼š**
- æ—¥å¿—æ¶ˆæ¯æ¸…æ™°ã€å‡†ç¡®ã€å®Œæ•´
- åŒ…å«è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯
- ä½¿ç”¨ç»Ÿä¸€çš„æ—¥å¿—æ ¼å¼
- åŒ…å«è¯·æ±‚IDã€ç”¨æˆ·IDç­‰è¿½è¸ªæ ‡è¯†
- é”™è¯¯æ—¥å¿—åŒ…å«å †æ ˆä¿¡æ¯

**ç¤ºä¾‹ï¼š**
```python
# æ­£ç¡®ï¼šåŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡
logger.error(
    "ASRæœåŠ¡è°ƒç”¨å¤±è´¥",
    extra={
        "request_id": request_id,
        "audio_size": len(audio_data),
        "error_type": type(e).__name__,
        "error_message": str(e)
    },
    exc_info=True  # åŒ…å«å †æ ˆä¿¡æ¯
)

# é”™è¯¯ï¼šä¿¡æ¯ä¸è¶³
logger.error("å¤±è´¥")
```

### 2.4 æ—¥å¿—ç­‰çº§è®¾ç½®è§„èŒƒ

#### 2.4.1 DEBUGï¼ˆè°ƒè¯•ï¼‰

**ç”¨é€”ï¼š** ç”¨äºè¾“å‡ºè°ƒè¯•æ€§è´¨çš„å†…å®¹ï¼Œä¸»è¦åœ¨å¼€å‘ã€æµ‹è¯•é˜¶æ®µä½¿ç”¨ã€‚

**ä½¿ç”¨åœºæ™¯ï¼š**
- å‡½æ•°è°ƒç”¨å‚æ•°
- ä¸­é—´å˜é‡å€¼
- è¯¦ç»†çš„æ‰§è¡Œæµç¨‹
- å¼€å‘è°ƒè¯•ä¿¡æ¯

**ç”Ÿäº§ç¯å¢ƒï¼š** é€šå¸¸ä¸å¯ç”¨ï¼Œæˆ–ä»…å¯¹ç‰¹å®šæ¨¡å—å¯ç”¨

**ç¤ºä¾‹ï¼š**
```python
logger.debug(f"å‡½æ•°è°ƒç”¨: process_audio(audio_size={len(audio)}, format={format})")
logger.debug(f"ä¸­é—´ç»“æœ: feature_vector shape={features.shape}")
```

#### 2.4.2 INFOï¼ˆä¿¡æ¯ï¼‰

**ç”¨é€”ï¼š** è®°å½•ç³»ç»Ÿå…³é”®ä¿¡æ¯ï¼Œä¿ç•™ç³»ç»Ÿæ­£å¸¸å·¥ä½œæœŸé—´çš„å…³é”®è¿è¡ŒæŒ‡æ ‡ã€‚

**ä½¿ç”¨åœºæ™¯ï¼š**
- æœåŠ¡å¯åŠ¨/åœæ­¢
- å…³é”®ä¸šåŠ¡æµç¨‹å¼€å§‹/å®Œæˆ
- é‡è¦çš„çŠ¶æ€å˜æ›´
- ä¸šåŠ¡æŒ‡æ ‡ç»Ÿè®¡

**ç”Ÿäº§ç¯å¢ƒï¼š** å¿…é¡»å¯ç”¨ï¼Œç”¨äºç›‘æ§ç³»ç»Ÿæ­£å¸¸è¿è¡ŒçŠ¶æ€

**ç¤ºä¾‹ï¼š**
```python
logger.info("è¯­éŸ³æœåŠ¡å¯åŠ¨æˆåŠŸï¼Œç›‘å¬ç«¯å£: 4999")
logger.info(f"ASRè¯†åˆ«å®Œæˆ: {result}, è€—æ—¶: {duration}ms")
logger.info(f"ä»»åŠ¡å®Œæˆ: task_id={task_id}, status=success")
```

#### 2.4.3 WARNï¼ˆè­¦å‘Šï¼‰

**ç”¨é€”ï¼š** è¾“å‡ºè­¦å‘Šæ€§è´¨çš„å†…å®¹ï¼Œé’ˆå¯¹å¯é¢„çŸ¥ä¸”æœ‰è§„åˆ’çš„å¼‚å¸¸æƒ…å†µã€‚

**ä½¿ç”¨åœºæ™¯ï¼š**
- å‚æ•°è¶…å‡ºå»ºè®®èŒƒå›´ä½†ä»åœ¨å¯æ¥å—èŒƒå›´
- é™çº§æœåŠ¡å¯ç”¨
- èµ„æºä½¿ç”¨ç‡è¾ƒé«˜
- å¯æ¢å¤çš„å¼‚å¸¸æƒ…å†µ

**ç”Ÿäº§ç¯å¢ƒï¼š** å¿…é¡»å¯ç”¨ï¼Œç”¨äºç›‘æ§æ½œåœ¨é—®é¢˜

**ç¤ºä¾‹ï¼š**
```python
logger.warning(f"éŸ³é¢‘é‡‡æ ·ç‡ {sample_rate}Hz ä¸åœ¨æ¨èèŒƒå›´ï¼Œä½¿ç”¨é»˜è®¤å¤„ç†")
logger.warning("MQTTè¿æ¥ä¸ç¨³å®šï¼Œå¯ç”¨é‡è¿æœºåˆ¶")
logger.warning(f"å†…å­˜ä½¿ç”¨ç‡: {memory_usage}%ï¼Œæ¥è¿‘é˜ˆå€¼")
```

#### 2.4.4 ERRORï¼ˆé”™è¯¯ï¼‰

**ç”¨é€”ï¼š** è®°å½•ä¸å¯é¢„çŸ¥çš„é”™è¯¯ã€å¼‚å¸¸ç­‰ä¸¥é‡é—®é¢˜ã€‚

**ä½¿ç”¨åœºæ™¯ï¼š**
- å¼‚å¸¸æ•è·
- APIè°ƒç”¨å¤±è´¥
- èµ„æºè·å–å¤±è´¥
- ä¸šåŠ¡é€»è¾‘é”™è¯¯
- æ•°æ®æ ¡éªŒå¤±è´¥

**ç”Ÿäº§ç¯å¢ƒï¼š** å¿…é¡»å¯ç”¨ï¼Œç”¨äºç›‘æ§ç³»ç»Ÿé”™è¯¯

**ç¤ºä¾‹ï¼š**
```python
logger.error(
    "ASRæœåŠ¡è°ƒç”¨å¤±è´¥",
    extra={
        "request_id": request_id,
        "error": str(e),
        "retry_count": retry_count
    },
    exc_info=True
)
```

#### 2.4.5 CRITICALï¼ˆä¸¥é‡ï¼‰

**ç”¨é€”ï¼š** è®°å½•ç³»ç»Ÿçº§ä¸¥é‡é”™è¯¯ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡ä¸å¯ç”¨ã€‚

**ä½¿ç”¨åœºæ™¯ï¼š**
- æœåŠ¡å¯åŠ¨å¤±è´¥
- å…³é”®ç»„ä»¶åˆå§‹åŒ–å¤±è´¥
- æ•°æ®æŸå
- ç³»ç»Ÿèµ„æºè€—å°½

**ç”Ÿäº§ç¯å¢ƒï¼š** å¿…é¡»å¯ç”¨ï¼Œéœ€è¦ç«‹å³å¤„ç†

**ç¤ºä¾‹ï¼š**
```python
logger.critical("æ•°æ®åº“è¿æ¥å¤±è´¥ï¼ŒæœåŠ¡æ— æ³•å¯åŠ¨", exc_info=True)
logger.critical(f"ç£ç›˜ç©ºé—´ä¸è¶³: {free_space}MBï¼ŒæœåŠ¡å¯èƒ½å¼‚å¸¸")
```

---

## 3. æ—¥å¿—æ ¼å¼ä¸ä½¿ç”¨è§„èŒƒ

### 3.1 æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–

ç³»ç»Ÿä½¿ç”¨ç»Ÿä¸€çš„æ—¥å¿—é…ç½®æ¨¡å— `logger_config.py`ï¼Œæä¾›ä¸¤ç§loggeråˆ›å»ºæ–¹å¼ï¼š

#### 3.1.1 æœºå™¨äººç«¯Logger

**é€‚ç”¨åœºæ™¯ï¼š** pipeline.py, mqtt_manager.py ç­‰æœºå™¨äººç«¯æ¨¡å—

**åˆ›å»ºæ–¹å¼ï¼š**
```python
from logger_config import create_robot_logger

# åˆ›å»ºæœºå™¨äººç«¯loggerï¼ˆç®€æ´æ ¼å¼ï¼‰
logger = create_robot_logger("pipeline", level="INFO")
```

**ç‰¹ç‚¹ï¼š**
- ç®€æ´æ ¼å¼ï¼Œä¾¿äºç»ˆç«¯æŸ¥çœ‹
- æ§åˆ¶å°å½©è‰²è¾“å‡º
- æ–‡ä»¶æ—¥å¿—è‡ªåŠ¨ä¿å­˜åˆ° `logs/` ç›®å½•
- è‡ªåŠ¨æ·»åŠ è¯·æ±‚IDæ”¯æŒ

**æ§åˆ¶å°è¾“å‡ºæ ¼å¼ï¼š**
```
10:30:15 [INFO] è¯†åˆ«ç»“æœ: å»åŠå…¬å®¤æ‹¿æ°´ç“¶
10:30:16 [WARNING] MQTTè¿æ¥ä¸ç¨³å®šï¼Œå¯ç”¨é‡è¿æœºåˆ¶
```

**æ–‡ä»¶è¾“å‡ºæ ¼å¼ï¼š**
```
2025-11-05 10:30:15 [INFO] è¯†åˆ«ç»“æœ: å»åŠå…¬å®¤æ‹¿æ°´ç“¶
2025-11-05 10:30:16 [WARNING] MQTTè¿æ¥ä¸ç¨³å®šï¼Œå¯ç”¨é‡è¿æœºåˆ¶
```

#### 3.1.2 æœåŠ¡ç«¯Logger

**é€‚ç”¨åœºæ™¯ï¼š** voice_services.py, http_agent_server.py, robot_tools.py ç­‰æœåŠ¡ç«¯æ¨¡å—

**åˆ›å»ºæ–¹å¼ï¼š**
```python
from logger_config import create_server_logger

# åˆ›å»ºæœåŠ¡ç«¯loggerï¼ˆè¯¦ç»†æ ¼å¼ï¼Œæ”¯æŒè¯·æ±‚IDï¼‰
logger = create_server_logger("voice_services", level="INFO", json_format=False)
```

**ç‰¹ç‚¹ï¼š**
- è¯¦ç»†æ ¼å¼ï¼ŒåŒ…å«æ¨¡å—åã€æ–‡ä»¶åã€è¡Œå·
- æ§åˆ¶å°å½©è‰²è¾“å‡º
- æ”¯æŒè¯·æ±‚IDè¿½è¸ª
- å¯é€‰JSONæ ¼å¼ï¼ˆä¾¿äºæ—¥å¿—åˆ†æï¼‰

**æ§åˆ¶å°è¾“å‡ºæ ¼å¼ï¼š**
```
10:30:15 [INFO] [voice_services] [ReqID:req_12345] ASRè¯†åˆ«å®Œæˆ: å»åŠå…¬å®¤æ‹¿æ°´ç“¶
10:30:16 [ERROR] [voice_services] [ReqID:req_12345] ASRæœåŠ¡è°ƒç”¨å¤±è´¥: Connection timeout
```

**æ–‡ä»¶è¾“å‡ºæ ¼å¼ï¼š**
```
2025-11-05 10:30:15 [INFO] [voice_services] [ReqID:req_12345] [voice_services.py:123] ASRè¯†åˆ«å®Œæˆ: å»åŠå…¬å®¤æ‹¿æ°´ç“¶
2025-11-05 10:30:16 [ERROR] [voice_services] [ReqID:req_12345] [voice_services.py:145] ASRæœåŠ¡è°ƒç”¨å¤±è´¥: Connection timeout
```

**JSONæ ¼å¼ï¼ˆå¯é€‰ï¼‰ï¼š**
```python
# å¯ç”¨JSONæ ¼å¼
logger = create_server_logger("voice_services", level="INFO", json_format=True)
```

**JSONè¾“å‡ºç¤ºä¾‹ï¼š**
```json
{"time":"2025-11-05 10:30:15","level":"INFO","name":"voice_services","request_id":"req_12345","message":"ASRè¯†åˆ«å®Œæˆ: å»åŠå…¬å®¤æ‹¿æ°´ç“¶"}
```

### 3.2 è¯·æ±‚IDè¿½è¸ª

**è®¾ç½®è¯·æ±‚IDï¼š**
```python
from logger_config import set_request_id, get_request_id, clear_request_id

# åœ¨è¯·æ±‚å¼€å§‹æ—¶è®¾ç½®è¯·æ±‚ID
request_id = f"req_{int(time.time() * 1000)}"
set_request_id(request_id)

# è·å–å½“å‰è¯·æ±‚ID
current_id = get_request_id()

# è¯·æ±‚ç»“æŸåæ¸…é™¤
clear_request_id()
```

**ä½¿ç”¨åœºæ™¯ï¼š**
- HTTPè¯·æ±‚å¤„ç†
- å¼‚æ­¥ä»»åŠ¡è¿½è¸ª
- åˆ†å¸ƒå¼ç³»ç»Ÿè°ƒç”¨é“¾è¿½è¸ª

### 3.3 æ—¥å¿—è®°å½•è§„èŒƒ

#### 3.3.1 è¯·æ±‚å¤„ç†æ—¥å¿—

**ä½¿ç”¨ä¾¿æ·å‡½æ•°ï¼š**
```python
from logger_config import log_request_start, log_request_end

# è®°å½•è¯·æ±‚å¼€å§‹
log_request_start(logger, "/asr/recognize", method="POST")

# è®°å½•è¯·æ±‚ç»“æŸ
log_request_end(logger, status_code=200, endpoint="/asr/recognize", duration_ms=350, status="success")
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
10:30:15 [INFO] [voice_services] [ReqID:req_12345] è¯·æ±‚å¼€å§‹ [POST] /asr/recognize
10:30:15 [INFO] [voice_services] [ReqID:req_12345] è¯·æ±‚ç»“æŸ [/asr/recognize] è€—æ—¶: 350.00ms çŠ¶æ€: success
```

**æ‰‹åŠ¨è®°å½•ï¼š**
```python
# è¯·æ±‚å¼€å§‹
logger.info(f"æ”¶åˆ°ASRè¯·æ±‚ï¼ŒéŸ³é¢‘å¤§å°: {len(audio_data)} å­—èŠ‚")

# è¯·æ±‚å¤„ç†ä¸­
logger.debug("å¼€å§‹è°ƒç”¨è…¾è®¯äº‘ASRæœåŠ¡")

# è¯·æ±‚å®Œæˆ
logger.info(f"ASRè¯†åˆ«å®Œæˆï¼Œç»“æœ: '{result}'ï¼Œè€—æ—¶: {duration:.2f}ms")
```

#### 3.3.2 ä»»åŠ¡æ‰§è¡Œæ—¥å¿—

**ä½¿ç”¨ä¾¿æ·å‡½æ•°ï¼š**
```python
from logger_config import log_task_add, log_task_start, log_task_complete

# ä»»åŠ¡å…¥é˜Ÿ
log_task_add(logger, "get_water_bottle", queue_len=3)

# ä»»åŠ¡å¼€å§‹
log_task_start(logger, "get_water_bottle")

# ä»»åŠ¡å®Œæˆ
log_task_complete(logger, "get_water_bottle", duration_s=45.2)
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
10:30:15 [INFO] [mqtt_manager] [ReqID:-] ä»»åŠ¡å…¥é˜Ÿ: get_water_bottle é˜Ÿåˆ—é•¿åº¦: 3
10:30:16 [INFO] [mqtt_manager] [ReqID:-] ä»»åŠ¡å¼€å§‹: get_water_bottle
10:31:01 [INFO] [mqtt_manager] [ReqID:-] ä»»åŠ¡å®Œæˆ: get_water_bottle è€—æ—¶: 45.20s
```

**æ‰‹åŠ¨è®°å½•ä»»åŠ¡æ­¥éª¤ï¼š**
```python
logger.info("ğŸ¯ å¼€å§‹æ‰§è¡Œæ‹¿æ°´ç“¶ä»»åŠ¡")
logger.info("  æ­¥éª¤1: å¯¼èˆªåˆ°åŠå…¬å®¤")
logger.info("  æ­¥éª¤2: æœºæ¢°è‡‚ç§»åŠ¨åˆ°æŠ“å–ä½ç½®")
logger.info("  æ­¥éª¤3: å¤¹çˆªå¤¹å–")
logger.info("âœ… ä»»åŠ¡å®Œæˆ")
```

#### 3.3.3 å·¥å…·è°ƒç”¨æ—¥å¿—

**ä½¿ç”¨ä¾¿æ·å‡½æ•°ï¼š**
```python
from logger_config import log_tool_call

# è®°å½•å·¥å…·è°ƒç”¨
log_tool_call(logger, "go_to_office", params={"x": 74.814, "y": 77.791})
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
10:30:15 [INFO] [robot_tools] [ReqID:req_12345] å·¥å…·è°ƒç”¨: go_to_office å‚æ•°: {'x': 74.814, 'y': 77.791}
```

#### 3.3.4 MQTTæ¶ˆæ¯æ—¥å¿—

**ä½¿ç”¨ä¾¿æ·å‡½æ•°ï¼š**
```python
from logger_config import log_mqtt_publish, log_mqtt_receive

# è®°å½•MQTTå‘å¸ƒï¼ˆDEBUGçº§åˆ«ï¼‰
log_mqtt_publish(logger, "robot/navigation", '{"x": 74.814, "y": 77.791, "z": 0.0}')

# è®°å½•MQTTæ¥æ”¶ï¼ˆDEBUGçº§åˆ«ï¼‰
log_mqtt_receive(logger, "robot/navigation", '{"x": 74.814, "y": 77.791, "z": 0.0}')
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
10:30:15 [DEBUG] [mqtt_manager] [ReqID:-] MQTTå‘å¸ƒ [robot/navigation] {"x": 74.814, "y": 77.791, "z": 0.0}
```

#### 3.3.5 è¯­éŸ³å¤„ç†æ—¥å¿—

**ä½¿ç”¨ä¾¿æ·å‡½æ•°ï¼š**
```python
from logger_config import log_vad_event, log_asr_result, log_tts_request

# VADäº‹ä»¶ï¼ˆDEBUGçº§åˆ«ï¼‰
log_vad_event(logger, "speech_start")

# ASRè¯†åˆ«ç»“æœ
log_asr_result(logger, "å»åŠå…¬å®¤æ‹¿æ°´ç“¶")

# TTSåˆæˆè¯·æ±‚
log_tts_request(logger, "å¥½çš„ï¼Œæˆ‘ç°åœ¨å»åŠå…¬å®¤æ‹¿æ°´ç“¶")
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
10:30:15 [DEBUG] [pipeline] [ReqID:-] VADäº‹ä»¶: speech_start
10:30:16 [INFO] [pipeline] [ReqID:-] ASRè¯†åˆ«: å»åŠå…¬å®¤æ‹¿æ°´ç“¶
10:30:17 [INFO] [pipeline] [ReqID:-] TTSåˆæˆ: å¥½çš„ï¼Œæˆ‘ç°åœ¨å»åŠå…¬å®¤æ‹¿æ°´ç“¶...
```

#### 3.3.6 é”™è¯¯æ—¥å¿—

**æ ‡å‡†é”™è¯¯è®°å½•ï¼š**
```python
try:
    result = call_external_api()
except Exception as e:
    logger.error(
        f"ASRæœåŠ¡è°ƒç”¨å¤±è´¥: {e}",
        extra={
            "error_type": type(e).__name__,
            "error_message": str(e),
            "retry_count": retry_count
        },
        exc_info=True  # åŒ…å«å †æ ˆä¿¡æ¯
    )
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
10:30:16 [ERROR] [voice_services] [ReqID:req_12345] ASRæœåŠ¡è°ƒç”¨å¤±è´¥: Connection timeout
Traceback (most recent call last):
  File "voice_services.py", line 145, in recognize_audio
    result = call_external_api()
ConnectionError: Connection timeout
```

#### 3.3.7 çŠ¶æ€å˜åŒ–æ—¥å¿—

**è®°å½•çŠ¶æ€å˜æ›´ï¼š**
```python
logger.info(f"å¯¼èˆªçŠ¶æ€æ›´æ–°: {old_status} â†’ {new_status}")
logger.info(f"æœºæ¢°è‡‚è¿è¡ŒçŠ¶æ€: running_status={self.arm_running_status}")
```

#### 3.3.8 æ€§èƒ½ç›‘æ§æ—¥å¿—

**è®°å½•æ€§èƒ½æŒ‡æ ‡ï¼š**
```python
start_time = time.time()
# ... æ‰§è¡Œæ“ä½œ ...
duration = (time.time() - start_time) * 1000
logger.info(f"ASRè¯†åˆ«è€—æ—¶: {duration:.2f}ms")
```

**æˆ–ä½¿ç”¨è¯·æ±‚ç»“æŸå‡½æ•°ï¼š**
```python
log_request_end(logger, endpoint="/asr/recognize", duration_ms=duration)
```

### 3.4 æ—¥å¿—çº§åˆ«ä½¿ç”¨

**DEBUGçº§åˆ«ï¼š**
- VADäº‹ä»¶ã€MQTTæ¶ˆæ¯è¯¦æƒ…ç­‰è°ƒè¯•ä¿¡æ¯
- ä»…åœ¨å¼€å‘è°ƒè¯•æ—¶å¯ç”¨

**INFOçº§åˆ«ï¼š**
- æœåŠ¡å¯åŠ¨/åœæ­¢
- è¯·æ±‚å¤„ç†ã€ä»»åŠ¡æ‰§è¡Œ
- å…³é”®ä¸šåŠ¡æµç¨‹
- ä¸šåŠ¡æŒ‡æ ‡ç»Ÿè®¡

**WARNINGçº§åˆ«ï¼š**
- å‚æ•°è¶…å‡ºå»ºè®®èŒƒå›´ä½†å¯æ¥å—
- é™çº§æœåŠ¡å¯ç”¨
- èµ„æºä½¿ç”¨ç‡è¾ƒé«˜
- å¯æ¢å¤çš„å¼‚å¸¸

**ERRORçº§åˆ«ï¼š**
- å¼‚å¸¸æ•è·
- APIè°ƒç”¨å¤±è´¥
- ä¸šåŠ¡é€»è¾‘é”™è¯¯
- å¿…é¡»åŒ…å« `exc_info=True` è®°å½•å †æ ˆ

**CRITICALçº§åˆ«ï¼š**
- æœåŠ¡å¯åŠ¨å¤±è´¥
- å…³é”®ç»„ä»¶åˆå§‹åŒ–å¤±è´¥
- ç³»ç»Ÿèµ„æºè€—å°½

---

## 4. æ—¥å¿—æ–‡ä»¶ç®¡ç†

### 4.1 æ—¥å¿—æ–‡ä»¶ä½ç½®

æ‰€æœ‰æ—¥å¿—æ–‡ä»¶è‡ªåŠ¨ä¿å­˜åˆ°é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ `logs/` ç›®å½•ï¼ŒæŒ‰æ¨¡å—ååˆ†ç¦»ï¼š

```
logs/
â”œâ”€â”€ pipeline.log           # è¯­éŸ³ç›‘å¬æ—¥å¿—
â”œâ”€â”€ mqtt_manager.log       # MQTTç®¡ç†æ—¥å¿—
â”œâ”€â”€ voice_services.log     # è¯­éŸ³æœåŠ¡æ—¥å¿—
â”œâ”€â”€ agent_server.log       # AgentæœåŠ¡æ—¥å¿—
â””â”€â”€ robot_tools.log        # å·¥å…·è°ƒç”¨æ—¥å¿—
```

### 4.2 æ—¥å¿—è½®è½¬

ç³»ç»Ÿä½¿ç”¨ `RotatingFileHandler` è‡ªåŠ¨è¿›è¡Œæ—¥å¿—è½®è½¬ï¼š

**é»˜è®¤é…ç½®ï¼š**
- å•ä¸ªæ–‡ä»¶æœ€å¤§ï¼š10MB
- ä¿ç•™å¤‡ä»½æ•°ï¼š5ä¸ª
- ç¼–ç æ ¼å¼ï¼šUTF-8

**è½®è½¬åçš„æ–‡ä»¶å‘½åï¼š**
```
pipeline.log          # å½“å‰æ—¥å¿—
pipeline.log.1        # ç¬¬ä¸€ä¸ªå¤‡ä»½ï¼ˆæœ€æ–°çš„æ—§æ—¥å¿—ï¼‰
pipeline.log.2        # ç¬¬äºŒä¸ªå¤‡ä»½
...
pipeline.log.5        # ç¬¬äº”ä¸ªå¤‡ä»½ï¼ˆæœ€æ—§çš„æ—¥å¿—ï¼‰
```

**è‡ªå®šä¹‰é…ç½®ï¼š**
```python
from logger_config import setup_logger

# è‡ªå®šä¹‰æ—¥å¿—è½®è½¬å‚æ•°
logger = setup_logger(
    name="custom_module",
    level="INFO",
    max_bytes=20*1024*1024,  # 20MB
    backup_count=10          # ä¿ç•™10ä¸ªå¤‡ä»½
)
```

### 4.3 æ—¥å¿—å½’æ¡£

**å»ºè®®ç­–ç•¥ï¼š**
- å®šæœŸå½’æ¡£æ—§æ—¥å¿—ï¼ˆå¦‚ï¼šæ¯æœˆå½’æ¡£ï¼‰
- å‹ç¼©å½’æ¡£æ–‡ä»¶ä»¥èŠ‚çœç©ºé—´
- è®¾ç½®ä¿ç•™æœŸé™ï¼ˆå¦‚ï¼šä¿ç•™3ä¸ªæœˆï¼‰
- å®šæœŸæ¸…ç†è¿‡æœŸæ—¥å¿—

---

## 5. æ—¥å¿—è®°å½•æœ€ä½³å®è·µ

### 5.1 æ—¥å¿—çº§åˆ«é€‰æ‹©

1. **DEBUG**: ä»…å¼€å‘è°ƒè¯•æ—¶å¯ç”¨
2. **INFO**: è®°å½•å…³é”®æ“ä½œå’ŒçŠ¶æ€å˜åŒ–
3. **WARNING**: è®°å½•æ½œåœ¨é—®é¢˜
4. **ERROR**: è®°å½•é”™è¯¯ä½†ç¨‹åºç»§ç»­è¿è¡Œ
5. **CRITICAL**: è®°å½•å¯¼è‡´ç¨‹åºå´©æºƒçš„é”™è¯¯

### 5.2 æ—¥å¿—å†…å®¹

1. **åŒ…å«è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯**
   - ä½¿ç”¨è¯·æ±‚IDè¿½è¸ªï¼ˆé€šè¿‡ `set_request_id()` è®¾ç½®ï¼‰
   - è®°å½•å…³é”®å‚æ•°å’ŒçŠ¶æ€ä¿¡æ¯
   - è®°å½•æ“ä½œè€—æ—¶

2. **ä¼˜å…ˆä½¿ç”¨ä¾¿æ·å‡½æ•°**
   - ä½¿ç”¨ `log_request_start/end` è®°å½•è¯·æ±‚
   - ä½¿ç”¨ `log_tool_call` è®°å½•å·¥å…·è°ƒç”¨
   - ä½¿ç”¨ `log_task_*` è®°å½•ä»»åŠ¡æ‰§è¡Œ
   - ç»Ÿä¸€æ ¼å¼ï¼Œä¾¿äºæ—¥å¿—åˆ†æ

3. **é¿å…è®°å½•æ•æ„Ÿä¿¡æ¯**
   - å¯†ç ã€Tokenã€APIå¯†é’¥ç­‰
   - ç”¨æˆ·éšç§ä¿¡æ¯
   - å†…éƒ¨é…ç½®ä¿¡æ¯

### 5.3 æ€§èƒ½è€ƒè™‘

1. **é¿å…åœ¨é«˜é¢‘å¾ªç¯ä¸­ä½¿ç”¨INFOçº§åˆ«æ—¥å¿—**
   - ä½¿ç”¨DEBUGçº§åˆ«
   - æˆ–ä½¿ç”¨é‡‡æ ·ç­–ç•¥ï¼ˆå¦‚ï¼šæ¯100æ¬¡è®°å½•ä¸€æ¬¡ï¼‰

2. **å¤§æ•°æ®å¯¹è±¡åªè®°å½•æ‘˜è¦ä¿¡æ¯**
   - ä¸è®°å½•å®Œæ•´çš„å¤§å¯¹è±¡
   - è®°å½•å…³é”®å­—æ®µæˆ–ç»Ÿè®¡ä¿¡æ¯
   - ä½¿ç”¨å ä½ç¬¦è¡¨ç¤ºå¤§æ•°æ®

3. **ä½¿ç”¨å¼‚æ­¥æ—¥å¿—é¿å…é˜»å¡**
   - ä½¿ç”¨å¼‚æ­¥æ—¥å¿—å¤„ç†å™¨
   - æˆ–ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ç¼“å†²æ—¥å¿—

**ç¤ºä¾‹ï¼š**
```python
# é”™è¯¯ï¼šåœ¨é«˜é¢‘å¾ªç¯ä¸­è®°å½•è¯¦ç»†æ—¥å¿—
for item in large_list:
    logger.info(f"å¤„ç†é¡¹ç›®: {item}")  # ä¼šäº§ç”Ÿå¤§é‡æ—¥å¿—

# æ­£ç¡®ï¼šä½¿ç”¨é‡‡æ ·æˆ–æ‘˜è¦
for i, item in enumerate(large_list):
    if i % 100 == 0:  # æ¯100æ¬¡è®°å½•ä¸€æ¬¡
        logger.info(f"å¤„ç†è¿›åº¦: {i}/{len(large_list)}")
    # æˆ–è®°å½•æ‘˜è¦
logger.info(f"å¤„ç†å®Œæˆ: æ€»è®¡ {len(large_list)} é¡¹")
```

### 5.4 æ—¥å¿—ç®¡ç†

1. **æ—¥å¿—è½®è½¬å·²è‡ªåŠ¨é…ç½®**
   - é»˜è®¤10MBå•æ–‡ä»¶ï¼Œä¿ç•™5ä¸ªå¤‡ä»½
   - å¯æ ¹æ®éœ€è¦è‡ªå®šä¹‰å‚æ•°

2. **å®šæœŸå½’æ¡£æˆ–æ¸…ç†æ—§æ—¥å¿—**
   - é¿å…ç£ç›˜ç©ºé—´è€—å°½
   - ç¬¦åˆåˆè§„è¦æ±‚

3. **è€ƒè™‘é›†ä¸­å¼æ—¥å¿—ç®¡ç†ï¼ˆå¦‚ELKï¼‰**
   - ç»Ÿä¸€æ”¶é›†å’Œåˆ†ææ—¥å¿—
   - æ”¯æŒå…¨æ–‡æœç´¢å’Œå¯è§†åŒ–
   - ä¾¿äºé—®é¢˜æ’æŸ¥å’Œç›‘æ§

---

## 6. ç›‘æ§å’Œå‘Šè­¦

### 6.1 å…³é”®æŒ‡æ ‡ç›‘æ§

#### 6.1.1 æœåŠ¡å¥åº·æŒ‡æ ‡

- HTTPè¯·æ±‚æˆåŠŸç‡
- å¹³å‡å“åº”æ—¶é—´
- å¹¶å‘è¿æ¥æ•°
- é”™è¯¯ç‡ï¼ˆæŒ‰é”™è¯¯ç ç»Ÿè®¡ï¼‰

#### 6.1.2 ä¸šåŠ¡æŒ‡æ ‡

- ASRè¯†åˆ«æˆåŠŸç‡
- TTSåˆæˆæˆåŠŸç‡
- å£°çº¹è®¤è¯é€šè¿‡ç‡
- å·¥å…·è°ƒç”¨æˆåŠŸç‡
- ä»»åŠ¡å®Œæˆç‡

#### 6.1.3 ç³»ç»ŸæŒ‡æ ‡

- CPUä½¿ç”¨ç‡
- å†…å­˜ä½¿ç”¨ç‡
- ç£ç›˜ä½¿ç”¨ç‡
- ç½‘ç»œæµé‡

### 6.2 å‘Šè­¦è§„åˆ™

**å»ºè®®å‘Šè­¦é˜ˆå€¼ï¼š**
- é”™è¯¯ç‡ > 5%ï¼šè­¦å‘Š
- é”™è¯¯ç‡ > 10%ï¼šä¸¥é‡
- å“åº”æ—¶é—´ > 5sï¼šè­¦å‘Š
- å“åº”æ—¶é—´ > 10sï¼šä¸¥é‡
- æœåŠ¡ä¸å¯ç”¨ï¼šä¸¥é‡

### 6.3 æ—¥å¿—ç›‘æ§å®ç°

**ä½¿ç”¨è¯·æ±‚ç»“æŸå‡½æ•°è®°å½•å…³é”®æŒ‡æ ‡ï¼š**
```python
from logger_config import log_request_end

# è®°å½•è¯·æ±‚å¤„ç†å®Œæˆï¼ˆåŒ…å«çŠ¶æ€ç å’Œè€—æ—¶ï¼‰
log_request_end(
    logger,
    status_code=200,
    endpoint="/asr/recognize",
    duration_ms=350,
    status="success"
)
```

**ç›‘æ§ç³»ç»Ÿå¯ä»¥ä»æ—¥å¿—ä¸­æå–è¿™äº›æŒ‡æ ‡ï¼š**
- ä»æ—¥å¿—æ–‡ä»¶è§£æçŠ¶æ€ç å’Œè€—æ—¶
- è®¡ç®—é”™è¯¯ç‡ã€å¹³å‡å“åº”æ—¶é—´ç­‰
- æ”¯æŒJSONæ ¼å¼æ—¥å¿—æ›´ä¾¿äºè§£æ

---

## 7. å‚è€ƒèµ„æº

### 7.1 ç›¸å…³æ–‡æ¡£

- [ç³»ç»Ÿæ—¥å¿—è§„èŒƒåŠæœ€ä½³å®è·µ](https://xie.infoq.cn/article/c7e46aa4bd7de3edb855c1f29)
- [Python loggingå®˜æ–¹æ–‡æ¡£](https://docs.python.org/3/library/logging.html)
- [é˜¿é‡Œäº‘æ—¥å¿—æœåŠ¡](https://help.aliyun.com/zh/sls/)

### 7.2 å·¥å…·æ¨è

- **æ—¥å¿—æ”¶é›†**: ELK Stack (Elasticsearch, Logstash, Kibana)
- **æ—¥å¿—åˆ†æ**: Grafana Loki
- **æ—¥å¿—ç›‘æ§**: Prometheus + Grafana
- **æ—¥å¿—è½®è½¬**: logrotate (Linux)

### 7.3 ç³»ç»Ÿå®ç°

- **æ—¥å¿—é…ç½®æ¨¡å—**: `logger_config.py`
- **æ—¥å¿—ç›®å½•**: `logs/`
- **æ—¥å¿—æ ¼å¼**: æ–‡æœ¬æ ¼å¼ï¼ˆé»˜è®¤ï¼‰æˆ–JSONæ ¼å¼ï¼ˆå¯é€‰ï¼‰


