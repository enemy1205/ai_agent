# è¯­éŸ³æ§åˆ¶æ™ºèƒ½æœºå™¨äººç³»ç»Ÿ - æ—¥å¿—è§„èŒƒ

## 1. æ–‡æ¡£è¯´æ˜

### 1.1 ç›®çš„

æœ¬æ–‡æ¡£æ—¨åœ¨è§„èŒƒåŒ–ç³»ç»Ÿå†…æ‰€æœ‰æ¨¡å—çš„æ—¥å¿—è¾“å‡ºæ ‡å‡†ï¼Œç¡®ä¿ï¼š
- æ—¥å¿—æ ¼å¼ç»Ÿä¸€ã€ä¿¡æ¯å®Œæ•´ã€ä¾¿äºè¿½è¸ª
- é—®é¢˜æ’æŸ¥é«˜æ•ˆã€ç³»ç»Ÿç›‘æ§ä¾¿æ·
- æ—¥å¿—è®°å½•éµå¾ªæœ€ä½³å®è·µå’Œç†è®ºåŸåˆ™

### 1.2 é€‚ç”¨èŒƒå›´

- æœºå™¨äººç«¯ï¼špipeline.py, mqtt_manager.py
- æœåŠ¡ç«¯ï¼švoice_services.py, http_agent_server.py, robot_tools.py
- æ‰€æœ‰éœ€è¦è®°å½•æ—¥å¿—çš„æ¨¡å—å’Œç»„ä»¶

### 1.3 ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®è®¢å†…å®¹ | ä½œè€… |
|-----|------|---------|------|
| v1.0 | 2025-11-05 | åˆå§‹ç‰ˆæœ¬ | enemy1205@qq.com |
| v1.1 | 2025-11-19 | æ—¥å¿—æ¥å£åˆ†ç¦» | enemy1205@qq.com |
---

## 2. æ—¥å¿—è®°å½•ç†è®ºåŸºç¡€

### 2.1 æ—¥å¿—è®°å½•çš„ç›®çš„

æ—¥å¿—è®°å½•æ˜¯ç³»ç»Ÿè¿è¡ŒçŠ¶æ€çš„é‡è¦è®°å½•æ‰‹æ®µï¼Œä¸»è¦æœåŠ¡äºä»¥ä¸‹ç›®çš„ï¼š

1. **è°ƒè¯•ï¼ˆDebuggingï¼‰**
   - å¸®åŠ©å¼€å‘äººå‘˜å®šä½ä»£ç é—®é¢˜
   - è¿½è¸ªç¨‹åºæ‰§è¡Œæµç¨‹
   - åˆ†æå¼‚å¸¸å’Œé”™è¯¯åŸå› 

2. **é—®é¢˜å®šä½ï¼ˆTroubleshootingï¼‰**
   - å¿«é€Ÿå®šä½ç”Ÿäº§ç¯å¢ƒé—®é¢˜
   - åˆ†æç³»ç»Ÿå¼‚å¸¸è¡Œä¸º
   - è¿½è¸ªé”™è¯¯å‘ç”Ÿçš„ä¸Šä¸‹æ–‡

3. **ç›‘æ§å‘Šè­¦ï¼ˆMonitoring & Alertingï¼‰**
   - å®æ—¶ç›‘æ§ç³»ç»Ÿå¥åº·çŠ¶æ€
   - è§¦å‘å¼‚å¸¸å‘Šè­¦
   - æ”¯æŒè‡ªåŠ¨åŒ–è¿ç»´

4. **ç”¨æˆ·è¡Œä¸ºå®¡è®¡ï¼ˆAuditingï¼‰**
   - è®°å½•å…³é”®æ“ä½œè½¨è¿¹
   - æ”¯æŒå®‰å…¨å®¡è®¡
   - æ»¡è¶³åˆè§„è¦æ±‚

5. **æ€§èƒ½åˆ†æï¼ˆPerformance Analysisï¼‰**
   - åˆ†æç³»ç»Ÿæ€§èƒ½ç“¶é¢ˆ
   - ä¼˜åŒ–å…³é”®è·¯å¾„
   - ç»Ÿè®¡ä¸šåŠ¡æŒ‡æ ‡

### 2.2 æ—¥å¿—è®°å½•çš„æ—¶æœº

åœ¨ä»¥ä¸‹åœºæ™¯ä¸‹å¿…é¡»è®°å½•æ—¥å¿—ï¼š

1. **ä»£ç åˆå§‹åŒ–**
   - æœåŠ¡å¯åŠ¨/åœæ­¢
   - æ¨¡å—åŠ è½½/å¸è½½
   - é…ç½®åŠ è½½å®Œæˆ

2. **è¿›å…¥é€»è¾‘å…¥å£**
   - APIè¯·æ±‚æ¥æ”¶
   - ä»»åŠ¡å¼€å§‹æ‰§è¡Œ
   - å…³é”®ä¸šåŠ¡æµç¨‹å¼€å§‹

3. **æ•è·å¼‚å¸¸**
   - try-catchå—æ•è·å¼‚å¸¸
   - é”™è¯¯å¤„ç†é€»è¾‘
   - å¼‚å¸¸æ¢å¤æ“ä½œ

4. **ä¸šåŠ¡æµç¨‹é¢„æœŸä¸ç¬¦**
   - å‚æ•°æ ¡éªŒå¤±è´¥
   - ä¸šåŠ¡è§„åˆ™æ ¡éªŒå¤±è´¥
   - çŠ¶æ€è½¬æ¢å¼‚å¸¸

5. **ç³»ç»Ÿ/ä¸šåŠ¡æ ¸å¿ƒé€»è¾‘çš„å…³é”®åŠ¨ä½œ**
   - æ•°æ®æŒä¹…åŒ–æ“ä½œ
   - å…³é”®çŠ¶æ€å˜æ›´
   - é‡è¦å†³ç­–ç‚¹

6. **ç¬¬ä¸‰æ–¹æœåŠ¡è¿œç¨‹è°ƒç”¨**
   - å¤–éƒ¨APIè°ƒç”¨å‰/å
   - ç½‘ç»œè¯·æ±‚å‘é€/æ¥æ”¶
   - æœåŠ¡é—´é€šä¿¡

### 2.3 æ—¥å¿—è®°å½•çš„åŸºæœ¬åŸåˆ™

#### 2.3.1 éš”ç¦»æ€§ï¼ˆIsolationï¼‰

**åŸåˆ™ï¼š** æ—¥å¿—è¾“å‡ºä¸èƒ½å½±å“ç³»ç»Ÿæ­£å¸¸è¿è¡Œã€‚

**å…·ä½“è¦æ±‚ï¼š**
- æ—¥å¿—è®°å½•æ“ä½œåº”è¯¥æ˜¯å¼‚æ­¥çš„æˆ–éé˜»å¡çš„
- æ—¥å¿—å†™å…¥å¤±è´¥ä¸åº”å¯¼è‡´ä¸šåŠ¡é€»è¾‘å¤±è´¥
- é¿å…åœ¨é«˜é¢‘å¾ªç¯ä¸­è¿›è¡Œå¤§é‡æ—¥å¿—è¾“å‡º
- æ—¥å¿—ç³»ç»Ÿæ•…éšœä¸åº”å½±å“ä¸»ä¸šåŠ¡åŠŸèƒ½

**ç¤ºä¾‹ï¼š**
```python
# æ­£ç¡®ï¼šä½¿ç”¨å¼‚æ­¥æ—¥å¿—æˆ–ç¡®ä¿æ—¥å¿—æ“ä½œå¿«é€Ÿå®Œæˆ
logger.info("å¤„ç†è¯·æ±‚", extra={"request_id": request_id})

# é”™è¯¯ï¼šåœ¨å…³é”®è·¯å¾„ä¸Šè¿›è¡Œè€—æ—¶æ—¥å¿—æ“ä½œ
logger.info(f"è¯¦ç»†æ•°æ®: {json.dumps(large_data)}")  # å¯èƒ½é˜»å¡
```

#### 2.3.2 å®‰å…¨æ€§ï¼ˆSecurityï¼‰

**åŸåˆ™ï¼š** æ—¥å¿—æ‰“å°æœ¬èº«ä¸èƒ½å­˜åœ¨é€»è¾‘å¼‚å¸¸æˆ–æ¼æ´ï¼Œå¯¼è‡´äº§ç”Ÿå®‰å…¨é—®é¢˜ã€‚

**å…·ä½“è¦æ±‚ï¼š**
- é¿å…æ—¥å¿—æ³¨å…¥æ”»å‡»ï¼ˆLog Injectionï¼‰
- é˜²æ­¢æ—¥å¿—ç³»ç»Ÿè¢«æ¶æ„åˆ©ç”¨
- æ—¥å¿—è®°å½•ä»£ç æœ¬èº«è¦å¥å£®
- é¿å…åœ¨æ—¥å¿—ä¸­æ‰§è¡Œå±é™©æ“ä½œ

**ç¤ºä¾‹ï¼š**
```python
# æ­£ç¡®ï¼šå¯¹ç”¨æˆ·è¾“å…¥è¿›è¡Œè½¬ä¹‰
logger.info(f"ç”¨æˆ·è¾“å…¥: {escape(user_input)}")

# é”™è¯¯ï¼šç›´æ¥è®°å½•æœªéªŒè¯çš„ç”¨æˆ·è¾“å…¥
logger.info(f"æ‰§è¡Œå‘½ä»¤: {user_input}")  # å¯èƒ½å­˜åœ¨æ³¨å…¥é£é™©
```

#### 2.3.3 æ•°æ®å®‰å…¨ï¼ˆData Securityï¼‰

**åŸåˆ™ï¼š** ä¸å…è®¸è¾“å‡ºæœºå¯†ã€æ•æ„Ÿä¿¡æ¯ã€‚

**ç¦æ­¢è®°å½•çš„ä¿¡æ¯ç±»å‹ï¼š**
- ç”¨æˆ·å¯†ç ã€Tokenã€APIå¯†é’¥
- èº«ä»½è¯å·ç ã€é“¶è¡Œå¡å·
- ç”¨æˆ·è”ç³»æ–¹å¼ï¼ˆæ‰‹æœºå·ã€é‚®ç®±ï¼‰
- æ•æ„Ÿä¸šåŠ¡æ•°æ®
- å†…éƒ¨ç³»ç»Ÿé…ç½®ä¿¡æ¯

**å¤„ç†æ–¹å¼ï¼š**
- æ•æ„Ÿä¿¡æ¯ä½¿ç”¨å ä½ç¬¦æ›¿ä»£ï¼ˆå¦‚ï¼š`****`ï¼‰
- å¯¹æ•æ„Ÿå­—æ®µè¿›è¡Œè„±æ•å¤„ç†
- è®°å½•æ‘˜è¦ä¿¡æ¯è€Œéå®Œæ•´æ•°æ®

**ç¤ºä¾‹ï¼š**
```python
# æ­£ç¡®ï¼šè„±æ•å¤„ç†
logger.info(f"ç”¨æˆ·ç™»å½•: user_id={user_id}, phone=****{phone[-4:]}")

# é”™è¯¯ï¼šè®°å½•å®Œæ•´æ•æ„Ÿä¿¡æ¯
logger.info(f"ç”¨æˆ·ç™»å½•: user_id={user_id}, phone={phone}, token={token}")
```

#### 2.3.4 å¯ç›‘æ§åˆ†æï¼ˆMonitorableï¼‰

**åŸåˆ™ï¼š** æ—¥å¿—å¯ä»¥æä¾›ç»™ç›‘æ§ç³»ç»Ÿè¿›è¡Œç›‘æ§å’Œåˆ†æã€‚

**å…·ä½“è¦æ±‚ï¼š**
- ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—æ ¼å¼ï¼ˆæ¨èJSONï¼‰
- åŒ…å«å¯è¢«ç›‘æ§ç³»ç»Ÿè¯†åˆ«çš„å­—æ®µ
- å…³é”®æŒ‡æ ‡æ˜“äºæå–å’Œç»Ÿè®¡
- æ”¯æŒæ—¥å¿—èšåˆå’Œåˆ†æå·¥å…·

**ç¤ºä¾‹ï¼š**
```python
# æ­£ç¡®ï¼šç»“æ„åŒ–æ—¥å¿—
logger.info("APIè¯·æ±‚", extra={
    "method": "POST",
    "endpoint": "/api/users",
    "status_code": 200,
    "duration_ms": 150,
    "request_id": request_id
})

# é”™è¯¯ï¼šéç»“æ„åŒ–æ—¥å¿—
logger.info(f"POST /api/users 200 150ms {request_id}")
```

#### 2.3.5 å¯å®šä½æ’æŸ¥ï¼ˆTraceableï¼‰

**åŸåˆ™ï¼š** æ—¥å¿—ä¿¡æ¯è¾“å‡ºéœ€æœ‰æ„ä¹‰ï¼Œéœ€å…·æœ‰å¯è¯»æ€§ï¼Œå¯ä¾›æ—¥å¸¸å¼€å‘åŒå­¦æ’æŸ¥çº¿ä¸Šé—®é¢˜ã€‚

**å…·ä½“è¦æ±‚ï¼š**
- æ—¥å¿—æ¶ˆæ¯æ¸…æ™°ã€å‡†ç¡®ã€å®Œæ•´
- åŒ…å«è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯
- ä½¿ç”¨ç»Ÿä¸€çš„æ—¥å¿—æ ¼å¼
- åŒ…å«è¯·æ±‚IDã€ç”¨æˆ·IDç­‰è¿½è¸ªæ ‡è¯†
- é”™è¯¯æ—¥å¿—åŒ…å«å †æ ˆä¿¡æ¯

**ç¤ºä¾‹ï¼š**
```python
# æ­£ç¡®ï¼šåŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡
logger.error(
    "ASRæœåŠ¡è°ƒç”¨å¤±è´¥",
    extra={
        "request_id": request_id,
        "audio_size": len(audio_data),
        "error_type": type(e).__name__,
        "error_message": str(e)
    },
    exc_info=True  # åŒ…å«å †æ ˆä¿¡æ¯
)

# é”™è¯¯ï¼šä¿¡æ¯ä¸è¶³
logger.error("å¤±è´¥")
```

### 2.4 æ—¥å¿—ç­‰çº§è®¾ç½®è§„èŒƒ

#### 2.4.1 DEBUGï¼ˆè°ƒè¯•ï¼‰

**ç”¨é€”ï¼š** ç”¨äºè¾“å‡ºè°ƒè¯•æ€§è´¨çš„å†…å®¹ï¼Œä¸»è¦åœ¨å¼€å‘ã€æµ‹è¯•é˜¶æ®µä½¿ç”¨ã€‚

**ä½¿ç”¨åœºæ™¯ï¼š**
- å‡½æ•°è°ƒç”¨å‚æ•°
- ä¸­é—´å˜é‡å€¼
- è¯¦ç»†çš„æ‰§è¡Œæµç¨‹
- å¼€å‘è°ƒè¯•ä¿¡æ¯

**ç”Ÿäº§ç¯å¢ƒï¼š** é€šå¸¸ä¸å¯ç”¨ï¼Œæˆ–ä»…å¯¹ç‰¹å®šæ¨¡å—å¯ç”¨

**ç¤ºä¾‹ï¼š**
```python
logger.debug(f"å‡½æ•°è°ƒç”¨: process_audio(audio_size={len(audio)}, format={format})")
logger.debug(f"ä¸­é—´ç»“æœ: feature_vector shape={features.shape}")
```

#### 2.4.2 INFOï¼ˆä¿¡æ¯ï¼‰

**ç”¨é€”ï¼š** è®°å½•ç³»ç»Ÿå…³é”®ä¿¡æ¯ï¼Œä¿ç•™ç³»ç»Ÿæ­£å¸¸å·¥ä½œæœŸé—´çš„å…³é”®è¿è¡ŒæŒ‡æ ‡ã€‚

**ä½¿ç”¨åœºæ™¯ï¼š**
- æœåŠ¡å¯åŠ¨/åœæ­¢
- å…³é”®ä¸šåŠ¡æµç¨‹å¼€å§‹/å®Œæˆ
- é‡è¦çš„çŠ¶æ€å˜æ›´
- ä¸šåŠ¡æŒ‡æ ‡ç»Ÿè®¡

**ç”Ÿäº§ç¯å¢ƒï¼š** å¿…é¡»å¯ç”¨ï¼Œç”¨äºç›‘æ§ç³»ç»Ÿæ­£å¸¸è¿è¡ŒçŠ¶æ€

**ç¤ºä¾‹ï¼š**
```python
logger.info("è¯­éŸ³æœåŠ¡å¯åŠ¨æˆåŠŸï¼Œç›‘å¬ç«¯å£: 4999")
logger.info(f"ASRè¯†åˆ«å®Œæˆ: {result}, è€—æ—¶: {duration}ms")
logger.info(f"ä»»åŠ¡å®Œæˆ: task_id={task_id}, status=success")
```

#### 2.4.3 WARNï¼ˆè­¦å‘Šï¼‰

**ç”¨é€”ï¼š** è¾“å‡ºè­¦å‘Šæ€§è´¨çš„å†…å®¹ï¼Œé’ˆå¯¹å¯é¢„çŸ¥ä¸”æœ‰è§„åˆ’çš„å¼‚å¸¸æƒ…å†µã€‚

**ä½¿ç”¨åœºæ™¯ï¼š**
- å‚æ•°è¶…å‡ºå»ºè®®èŒƒå›´ä½†ä»åœ¨å¯æ¥å—èŒƒå›´
- é™çº§æœåŠ¡å¯ç”¨
- èµ„æºä½¿ç”¨ç‡è¾ƒé«˜
- å¯æ¢å¤çš„å¼‚å¸¸æƒ…å†µ

**ç”Ÿäº§ç¯å¢ƒï¼š** å¿…é¡»å¯ç”¨ï¼Œç”¨äºç›‘æ§æ½œåœ¨é—®é¢˜

**ç¤ºä¾‹ï¼š**
```python
logger.warning(f"éŸ³é¢‘é‡‡æ ·ç‡ {sample_rate}Hz ä¸åœ¨æ¨èèŒƒå›´ï¼Œä½¿ç”¨é»˜è®¤å¤„ç†")
logger.warning("MQTTè¿æ¥ä¸ç¨³å®šï¼Œå¯ç”¨é‡è¿æœºåˆ¶")
logger.warning(f"å†…å­˜ä½¿ç”¨ç‡: {memory_usage}%ï¼Œæ¥è¿‘é˜ˆå€¼")
```

#### 2.4.4 ERRORï¼ˆé”™è¯¯ï¼‰

**ç”¨é€”ï¼š** è®°å½•ä¸å¯é¢„çŸ¥çš„é”™è¯¯ã€å¼‚å¸¸ç­‰ä¸¥é‡é—®é¢˜ã€‚

**ä½¿ç”¨åœºæ™¯ï¼š**
- å¼‚å¸¸æ•è·
- APIè°ƒç”¨å¤±è´¥
- èµ„æºè·å–å¤±è´¥
- ä¸šåŠ¡é€»è¾‘é”™è¯¯
- æ•°æ®æ ¡éªŒå¤±è´¥

**ç”Ÿäº§ç¯å¢ƒï¼š** å¿…é¡»å¯ç”¨ï¼Œç”¨äºç›‘æ§ç³»ç»Ÿé”™è¯¯

**ç¤ºä¾‹ï¼š**
```python
logger.error(
    "ASRæœåŠ¡è°ƒç”¨å¤±è´¥",
    extra={
        "request_id": request_id,
        "error": str(e),
        "retry_count": retry_count
    },
    exc_info=True
)
```

#### 2.4.5 CRITICALï¼ˆä¸¥é‡ï¼‰

**ç”¨é€”ï¼š** è®°å½•ç³»ç»Ÿçº§ä¸¥é‡é”™è¯¯ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡ä¸å¯ç”¨ã€‚

**ä½¿ç”¨åœºæ™¯ï¼š**
- æœåŠ¡å¯åŠ¨å¤±è´¥
- å…³é”®ç»„ä»¶åˆå§‹åŒ–å¤±è´¥
- æ•°æ®æŸå
- ç³»ç»Ÿèµ„æºè€—å°½

**ç”Ÿäº§ç¯å¢ƒï¼š** å¿…é¡»å¯ç”¨ï¼Œéœ€è¦ç«‹å³å¤„ç†

**ç¤ºä¾‹ï¼š**
```python
logger.critical("æ•°æ®åº“è¿æ¥å¤±è´¥ï¼ŒæœåŠ¡æ— æ³•å¯åŠ¨", exc_info=True)
logger.critical(f"ç£ç›˜ç©ºé—´ä¸è¶³: {free_space}MBï¼ŒæœåŠ¡å¯èƒ½å¼‚å¸¸")
```

---

## 3. æ—¥å¿—æ ¼å¼è§„èŒƒ

### 3.1 æ—¥å¿—æ ¼å¼åˆ†ç±»

æ ¹æ®ç”¨é€”å’Œç‰¹ç‚¹ï¼Œæ—¥å¿—å¯åˆ†ä¸ºä¸‰ç±»ï¼š

#### 3.1.1 æ‘˜è¦æ—¥å¿—ï¼ˆSummary Logï¼‰

**å®šä¹‰ï¼š** æ ¼å¼åŒ–çš„æ ‡å‡†æ—¥å¿—æ–‡ä»¶ï¼Œå¯ç”¨äºç›‘æ§ç³»ç»Ÿè¿›è¡Œç›‘æ§é…ç½®å’Œç¦»çº¿æ—¥å¿—åˆ†æã€‚

**ç‰¹ç‚¹ï¼š**
- ç»“æ„åŒ–æ ¼å¼ï¼ˆæ¨èJSONï¼‰
- åŒ…å«å…³é”®å­—æ®µå’ŒæŒ‡æ ‡
- æ˜“äºè§£æå’Œç»Ÿè®¡
- é€‚åˆè‡ªåŠ¨åŒ–å¤„ç†

**æ ¼å¼è¦æ±‚ï¼š**
- ä½¿ç”¨ç»Ÿä¸€çš„å­—æ®µå
- åŒ…å«æ—¶é—´æˆ³ã€çº§åˆ«ã€æ¨¡å—ç­‰æ ‡å‡†å­—æ®µ
- å…³é”®ä¸šåŠ¡å­—æ®µæ ‡å‡†åŒ–

**ç¤ºä¾‹ï¼š**
```json
{
  "timestamp": "2025-11-05T10:30:15.123Z",
  "level": "INFO",
  "module": "voice_services",
  "thread": "MainThread",
  "request_id": "req_1699876543",
  "event": "asr_request",
  "audio_size": 10240,
  "duration_ms": 350,
  "result": "å»åŠå…¬å®¤æ‹¿æ°´ç“¶",
  "success": true
}
```

#### 3.1.2 è¯¦ç»†æ—¥å¿—ï¼ˆDetail Logï¼‰

**å®šä¹‰ï¼š** ç”¨äºè¡¥å……æ‘˜è¦æ—¥å¿—ä¸­çš„ä¸šåŠ¡å‚æ•°ï¼Œæ–¹ä¾¿é—®é¢˜æ’æŸ¥ã€‚

**ç‰¹ç‚¹ï¼š**
- åŒ…å«è¯¦ç»†çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
- è®°å½•å®Œæ•´çš„è¯·æ±‚/å“åº”æ•°æ®
- åŒ…å«è°ƒè¯•ä¿¡æ¯
- ä¾¿äºäººå·¥é˜…è¯»å’Œåˆ†æ

**ä½¿ç”¨åœºæ™¯ï¼š**
- é—®é¢˜æ’æŸ¥æ—¶å¯ç”¨
- å¼€å‘æµ‹è¯•ç¯å¢ƒ
- ç‰¹å®šæ¨¡å—çš„è¯¦ç»†è¿½è¸ª

**ç¤ºä¾‹ï¼š**
```python
logger.info(
    "ASRè¯·æ±‚è¯¦æƒ…",
    extra={
        "request_id": request_id,
        "audio_format": "WAV",
        "sample_rate": 16000,
        "channels": 1,
        "duration_seconds": 3.5,
        "audio_base64_length": len(audio_base64),
        "tencent_api_response": api_response  # è¯¦ç»†å“åº”
    }
)
```

#### 3.1.3 ä¸šåŠ¡æ‰§è¡Œæ—¥å¿—ï¼ˆBusiness Execution Logï¼‰

**å®šä¹‰ï¼š** ç³»ç»Ÿæ‰§è¡Œè¿‡ç¨‹ä¸­è¾“å‡ºçš„æ—¥å¿—ï¼Œç”¨äºè·Ÿè¸ªä»£ç æ‰§è¡Œé€»è¾‘ã€‚

**ç‰¹ç‚¹ï¼š**
- è®°å½•ä¸šåŠ¡æµç¨‹çš„å…³é”®æ­¥éª¤
- åŒ…å«ä¸šåŠ¡çŠ¶æ€å˜æ›´
- è¿½è¸ªä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹
- æ”¯æŒä¸šåŠ¡å®¡è®¡

**ç¤ºä¾‹ï¼š**
```python
logger.info("ğŸ¯ å¼€å§‹æ‰§è¡Œæ‹¿æ°´ç“¶ä»»åŠ¡")
logger.info("  æ­¥éª¤1: å¯¼èˆªåˆ°åŠå…¬å®¤")
logger.info("  æ­¥éª¤2: æœºæ¢°è‡‚ç§»åŠ¨åˆ°æŠ“å–ä½ç½®")
logger.info("  æ­¥éª¤3: å¤¹çˆªå¤¹å–")
logger.info("âœ… ä»»åŠ¡å®Œæˆ")
```

### 3.2 æ ‡å‡†æ ¼å¼

#### 3.2.1 æ–‡æœ¬æ ¼å¼

**æ ¼å¼æ¨¡æ¿ï¼š**
```
[æ—¶é—´æˆ³] [çº§åˆ«] [æ¨¡å—] [çº¿ç¨‹] - æ¶ˆæ¯å†…å®¹
```

**ç¤ºä¾‹ï¼š**
```
[2025-11-05 10:30:15.123] INFO [pipeline] [MainThread] - ğŸ—£ï¸ è¯†åˆ«ç»“æœ: å»åŠå…¬å®¤æ‹¿æ°´ç“¶
[2025-11-05 10:30:16.456] ERROR [voice_services] [Thread-1] - âŒ ASR æœåŠ¡è°ƒç”¨å¤±è´¥: Connection timeout
```

#### 3.2.2 JSONæ ¼å¼ï¼ˆæ¨èï¼‰

**æ ¼å¼æ¨¡æ¿ï¼š**
```json
{
  "timestamp": "ISO8601æ—¶é—´æˆ³",
  "level": "æ—¥å¿—çº§åˆ«",
  "module": "æ¨¡å—å",
  "thread": "çº¿ç¨‹å",
  "message": "æ—¥å¿—æ¶ˆæ¯",
  "extra": {
    // é¢å¤–å­—æ®µ
  }
}
```

**ç¤ºä¾‹ï¼š**
```json
{
  "timestamp": "2025-11-05T10:30:15.123Z",
  "level": "INFO",
  "module": "pipeline",
  "thread": "MainThread",
  "message": "è¯†åˆ«ç»“æœ",
  "result": "å»åŠå…¬å®¤æ‹¿æ°´ç“¶",
  "request_id": "req_1699876543"
}
```

### 3.3 Pythonæ—¥å¿—é…ç½®

#### 3.3.1 åŸºç¡€é…ç½®

```python
import logging
from logging.handlers import RotatingFileHandler

logging.basicConfig(
    level=logging.INFO,
    format='[%(asctime)s] %(levelname)s [%(name)s] [%(threadName)s] - %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S',
    handlers=[
        logging.StreamHandler(),  # æ§åˆ¶å°è¾“å‡º
        RotatingFileHandler(
            'app.log',
            maxBytes=10*1024*1024,  # 10MB
            backupCount=5,
            encoding='utf-8'
        )
    ]
)

logger = logging.getLogger(__name__)
```

#### 3.3.2 JSONæ ¼å¼é…ç½®

```python
import logging
import json
from datetime import datetime

class JSONFormatter(logging.Formatter):
    def format(self, record):
        log_data = {
            "timestamp": datetime.utcnow().isoformat() + "Z",
            "level": record.levelname,
            "module": record.name,
            "thread": record.threadName,
            "message": record.getMessage(),
        }
        
        # æ·»åŠ extraå­—æ®µ
        if hasattr(record, 'request_id'):
            log_data['request_id'] = record.request_id
        if hasattr(record, 'user_id'):
            log_data['user_id'] = record.user_id
        
        # æ·»åŠ å¼‚å¸¸ä¿¡æ¯
        if record.exc_info:
            log_data['exception'] = self.formatException(record.exc_info)
        
        return json.dumps(log_data, ensure_ascii=False)

handler = logging.StreamHandler()
handler.setFormatter(JSONFormatter())
logger = logging.getLogger(__name__)
logger.addHandler(handler)
logger.setLevel(logging.INFO)
```

#### 3.3.3 ROSç¯å¢ƒé…ç½®

```python
import rospy

# ROSæ—¥å¿—è‡ªåŠ¨åŒ…å«æ—¶é—´æˆ³å’Œçº§åˆ«
rospy.loginfo("å¯¼èˆªä»»åŠ¡å·²å®Œæˆ")
rospy.logwarn("æ£€æµ‹åˆ°æ‰‹æŸ„æ§åˆ¶æ¨¡å¼")
rospy.logerr("MQTTè¿æ¥å¤±è´¥")
rospy.logdebug("è°ƒè¯•ä¿¡æ¯: å½“å‰ä½ç½® x=%.2f, y=%.2f", x, y)
```

---

## 4. æ—¥å¿—å†…å®¹è§„èŒƒ

### 4.1 è¯·æ±‚å¤„ç†æ—¥å¿—

**æ ¼å¼ï¼š**
```
-> æ”¶åˆ°{è¯·æ±‚ç±»å‹}è¯·æ±‚: {å…³é”®å‚æ•°}
   å¤„ç†ä¸­...
<- å“åº”: {ç»“æœæ‘˜è¦}
```

**ç¤ºä¾‹ï¼š**
```python
logger.info(f"-> æ”¶åˆ°ASRè¯·æ±‚ï¼ŒéŸ³é¢‘å¤§å°: {len(audio_data)} å­—èŠ‚")
logger.info("   å¤„ç†ä¸­...")
logger.info("<- ASRè¯†åˆ«å®Œæˆï¼Œç»“æœ: 'å»åŠå…¬å®¤æ‹¿æ°´ç“¶'")
```

**ç»“æ„åŒ–æ ¼å¼ï¼š**
```python
logger.info(
    "ASRè¯·æ±‚",
    extra={
        "direction": "inbound",
        "request_type": "ASR",
        "audio_size": len(audio_data),
        "request_id": request_id
    }
)

logger.info(
    "ASRå“åº”",
    extra={
        "direction": "outbound",
        "request_type": "ASR",
        "result": result,
        "duration_ms": duration,
        "request_id": request_id
    }
)
```

### 4.2 ä»»åŠ¡æ‰§è¡Œæ—¥å¿—

**æ ¼å¼ï¼š**
```
ğŸ¯ å¼€å§‹æ‰§è¡Œ: {ä»»åŠ¡åç§°}
  æ­¥éª¤1: {æ­¥éª¤æè¿°}
  æ­¥éª¤2: {æ­¥éª¤æè¿°}
  ...
âœ… ä»»åŠ¡å®Œæˆ / âŒ ä»»åŠ¡å¤±è´¥: {åŸå› }
```

**ç¤ºä¾‹ï¼š**
```python
logger.info("ğŸ¯ å¼€å§‹æ‰§è¡Œæ‹¿æ°´ç“¶ä»»åŠ¡")
logger.info("  æ­¥éª¤1: æ¾å¼€å¤¹çˆª")
logger.info("  æ­¥éª¤2: æœºæ¢°è‡‚ç§»åŠ¨åˆ°æŠ“å–ä½ç½®")
logger.info("  æ­¥éª¤3: å¤¹çˆªå¤¹å–")
logger.info("  æ­¥éª¤4: æœºæ¢°è‡‚æŠ¬å‡")
logger.info("âœ… ä»»åŠ¡å®Œæˆ")
```

**ç»“æ„åŒ–æ ¼å¼ï¼š**
```python
logger.info(
    "ä»»åŠ¡å¼€å§‹",
    extra={
        "task_id": task_id,
        "task_type": "get_water_bottle",
        "status": "started"
    }
)

logger.info(
    "ä»»åŠ¡æ­¥éª¤",
    extra={
        "task_id": task_id,
        "step": 1,
        "step_name": "æ¾å¼€å¤¹çˆª",
        "status": "completed"
    }
)

logger.info(
    "ä»»åŠ¡å®Œæˆ",
    extra={
        "task_id": task_id,
        "task_type": "get_water_bottle",
        "status": "completed",
        "duration_ms": duration
    }
)
```

### 4.3 é”™è¯¯æ—¥å¿—

**æ ¼å¼ï¼š**
```
âŒ é”™è¯¯: {é”™è¯¯ç±»å‹}
   ä½ç½®: {æ¨¡å—}.{å‡½æ•°}
   åŸå› : {é”™è¯¯åŸå› }
   è¯¦æƒ…: {è¯¦ç»†ä¿¡æ¯}
   [å †æ ˆ: {å¼‚å¸¸å †æ ˆ}]
```

**ç¤ºä¾‹ï¼š**
```python
try:
    result = call_external_api()
except Exception as e:
    logger.error(
        f"âŒ APIè°ƒç”¨å¤±è´¥: {e}",
        extra={
            "location": "voice_services.recognize_audio_with_tencent",
            "error_type": type(e).__name__,
            "error_message": str(e),
            "request_id": request_id
        },
        exc_info=True  # åŒ…å«å †æ ˆä¿¡æ¯
    )
```

**ç»“æ„åŒ–æ ¼å¼ï¼š**
```python
logger.error(
    "APIè°ƒç”¨å¤±è´¥",
    extra={
        "error_type": "ConnectionError",
        "error_message": "Connection timeout",
        "module": "voice_services",
        "function": "recognize_audio_with_tencent",
        "request_id": request_id,
        "retry_count": retry_count
    },
    exc_info=True
)
```

### 4.4 çŠ¶æ€å˜åŒ–æ—¥å¿—

**æ ¼å¼ï¼š**
```
ğŸ“Š çŠ¶æ€æ›´æ–°: {å¯¹è±¡} {æ—§çŠ¶æ€} â†’ {æ–°çŠ¶æ€}
```

**ç¤ºä¾‹ï¼š**
```python
logger.info(f"ğŸ“Š å¯¼èˆªçŠ¶æ€æ›´æ–°: {old_status} â†’ {new_status}")
logger.info(f"ğŸ“Š æœºæ¢°è‡‚è¿è¡ŒçŠ¶æ€: running_status={self.arm_running_status}")
```

**ç»“æ„åŒ–æ ¼å¼ï¼š**
```python
logger.info(
    "çŠ¶æ€æ›´æ–°",
    extra={
        "object": "navigation",
        "old_status": old_status,
        "new_status": new_status,
        "timestamp": time.time()
    }
)
```

### 4.5 æ€§èƒ½ç›‘æ§æ—¥å¿—

**æ ¼å¼ï¼š**
```
â±ï¸ æ€§èƒ½ç»Ÿè®¡: {æ“ä½œåç§°}
   è€—æ—¶: {duration}ms
   [å…¶ä»–æŒ‡æ ‡]
```

**ç¤ºä¾‹ï¼š**
```python
start_time = time.time()
# ... æ‰§è¡Œæ“ä½œ ...
duration = (time.time() - start_time) * 1000
logger.info(f"â±ï¸ ASRè¯†åˆ«è€—æ—¶: {duration:.2f}ms")
```

**ç»“æ„åŒ–æ ¼å¼ï¼š**
```python
logger.info(
    "æ€§èƒ½ç»Ÿè®¡",
    extra={
        "operation": "ASRè¯†åˆ«",
        "duration_ms": duration,
        "audio_size": len(audio_data),
        "request_id": request_id
    }
)
```

---

## 5. æ—¥å¿—æ–‡ä»¶ç®¡ç†

### 5.1 æ—¥å¿—è½®è½¬

**é…ç½®ç¤ºä¾‹ï¼š**
```python
from logging.handlers import RotatingFileHandler

handler = RotatingFileHandler(
    'app.log',
    maxBytes=10*1024*1024,  # 10MB
    backupCount=5,           # ä¿ç•™5ä¸ªå¤‡ä»½
    encoding='utf-8'
)
```

**å‘½åè§„èŒƒï¼š**
```
app.log          # å½“å‰æ—¥å¿—
app.log.1        # ç¬¬ä¸€ä¸ªå¤‡ä»½
app.log.2        # ç¬¬äºŒä¸ªå¤‡ä»½
...
```

### 5.2 æ—¥å¿—åˆ†ç±»

**å»ºè®®æŒ‰æ¨¡å—åˆ†ç¦»æ—¥å¿—ï¼š**
```
logs/
â”œâ”€â”€ voice_service.log      # è¯­éŸ³æœåŠ¡æ—¥å¿—
â”œâ”€â”€ agent_service.log      # AgentæœåŠ¡æ—¥å¿—
â”œâ”€â”€ pipeline.log           # è¯­éŸ³ç›‘å¬æ—¥å¿—
â”œâ”€â”€ mqtt_manager.log       # MQTTç®¡ç†æ—¥å¿—
â””â”€â”€ robot_tools.log        # å·¥å…·è°ƒç”¨æ—¥å¿—
```

**é…ç½®ç¤ºä¾‹ï¼š**
```python
# ä¸ºä¸åŒæ¨¡å—åˆ›å»ºä¸åŒçš„æ—¥å¿—æ–‡ä»¶
voice_logger = logging.getLogger('voice_services')
voice_handler = RotatingFileHandler('logs/voice_service.log', maxBytes=10*1024*1024, backupCount=5)
voice_logger.addHandler(voice_handler)

agent_logger = logging.getLogger('agent_server')
agent_handler = RotatingFileHandler('logs/agent_service.log', maxBytes=10*1024*1024, backupCount=5)
agent_logger.addHandler(agent_handler)
```

### 5.3 æ—¥å¿—å½’æ¡£

**ç­–ç•¥ï¼š**
- å®šæœŸå½’æ¡£æ—§æ—¥å¿—ï¼ˆå¦‚ï¼šæ¯æœˆå½’æ¡£ï¼‰
- å‹ç¼©å½’æ¡£æ–‡ä»¶ä»¥èŠ‚çœç©ºé—´
- è®¾ç½®ä¿ç•™æœŸé™ï¼ˆå¦‚ï¼šä¿ç•™3ä¸ªæœˆï¼‰
- å®šæœŸæ¸…ç†è¿‡æœŸæ—¥å¿—

---

## 6. æ—¥å¿—è®°å½•æœ€ä½³å®è·µ

### 6.1 æ—¥å¿—çº§åˆ«é€‰æ‹©

1. **DEBUG**: ä»…å¼€å‘è°ƒè¯•æ—¶å¯ç”¨
2. **INFO**: è®°å½•å…³é”®æ“ä½œå’ŒçŠ¶æ€å˜åŒ–
3. **WARNING**: è®°å½•æ½œåœ¨é—®é¢˜
4. **ERROR**: è®°å½•é”™è¯¯ä½†ç¨‹åºç»§ç»­è¿è¡Œ
5. **CRITICAL**: è®°å½•å¯¼è‡´ç¨‹åºå´©æºƒçš„é”™è¯¯

### 6.2 æ—¥å¿—å†…å®¹

1. **åŒ…å«è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯**
   - è¯·æ±‚IDã€ç”¨æˆ·IDã€ä»»åŠ¡IDç­‰è¿½è¸ªæ ‡è¯†
   - å…³é”®å‚æ•°å’ŒçŠ¶æ€ä¿¡æ¯
   - æ—¶é—´æˆ³å’ŒæŒç»­æ—¶é—´

2. **ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—ï¼ˆæ¨èJSONæ ¼å¼ï¼‰**
   - ä¾¿äºè§£æå’Œç»Ÿè®¡
   - æ”¯æŒæ—¥å¿—èšåˆå·¥å…·
   - æ˜“äºç›‘æ§ç³»ç»Ÿé›†æˆ

3. **è®°å½•è¯·æ±‚IDä¾¿äºè¿½è¸ª**
   - åœ¨è¯·æ±‚å¼€å§‹æ—¶ç”Ÿæˆå”¯ä¸€ID
   - åœ¨æ—¥å¿—ä¸­è´¯ç©¿æ•´ä¸ªè¯·æ±‚ç”Ÿå‘½å‘¨æœŸ
   - æ”¯æŒåˆ†å¸ƒå¼è¿½è¸ª

4. **é¿å…è®°å½•æ•æ„Ÿä¿¡æ¯**
   - å¯†ç ã€Tokenã€å¯†é’¥ç­‰
   - ç”¨æˆ·éšç§ä¿¡æ¯
   - å†…éƒ¨é…ç½®ä¿¡æ¯

### 6.3 æ€§èƒ½è€ƒè™‘

1. **é¿å…åœ¨é«˜é¢‘å¾ªç¯ä¸­ä½¿ç”¨INFOçº§åˆ«æ—¥å¿—**
   - ä½¿ç”¨DEBUGçº§åˆ«
   - æˆ–ä½¿ç”¨é‡‡æ ·ç­–ç•¥ï¼ˆå¦‚ï¼šæ¯100æ¬¡è®°å½•ä¸€æ¬¡ï¼‰

2. **å¤§æ•°æ®å¯¹è±¡åªè®°å½•æ‘˜è¦ä¿¡æ¯**
   - ä¸è®°å½•å®Œæ•´çš„å¤§å¯¹è±¡
   - è®°å½•å…³é”®å­—æ®µæˆ–ç»Ÿè®¡ä¿¡æ¯
   - ä½¿ç”¨å ä½ç¬¦è¡¨ç¤ºå¤§æ•°æ®

3. **ä½¿ç”¨å¼‚æ­¥æ—¥å¿—é¿å…é˜»å¡**
   - ä½¿ç”¨å¼‚æ­¥æ—¥å¿—å¤„ç†å™¨
   - æˆ–ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ç¼“å†²æ—¥å¿—

**ç¤ºä¾‹ï¼š**
```python
# é”™è¯¯ï¼šåœ¨é«˜é¢‘å¾ªç¯ä¸­è®°å½•è¯¦ç»†æ—¥å¿—
for item in large_list:
    logger.info(f"å¤„ç†é¡¹ç›®: {item}")  # ä¼šäº§ç”Ÿå¤§é‡æ—¥å¿—

# æ­£ç¡®ï¼šä½¿ç”¨é‡‡æ ·æˆ–æ‘˜è¦
for i, item in enumerate(large_list):
    if i % 100 == 0:  # æ¯100æ¬¡è®°å½•ä¸€æ¬¡
        logger.info(f"å¤„ç†è¿›åº¦: {i}/{len(large_list)}")
    # æˆ–è®°å½•æ‘˜è¦
logger.info(f"å¤„ç†å®Œæˆ: æ€»è®¡ {len(large_list)} é¡¹")
```

### 6.4 æ—¥å¿—ç®¡ç†

1. **å®æ–½æ—¥å¿—è½®è½¬ç­–ç•¥**
   - è®¾ç½®åˆç†çš„æ–‡ä»¶å¤§å°é™åˆ¶
   - ä¿ç•™é€‚å½“æ•°é‡çš„å¤‡ä»½æ–‡ä»¶

2. **å®šæœŸå½’æ¡£æˆ–æ¸…ç†æ—§æ—¥å¿—**
   - é¿å…ç£ç›˜ç©ºé—´è€—å°½
   - ç¬¦åˆåˆè§„è¦æ±‚

3. **è€ƒè™‘é›†ä¸­å¼æ—¥å¿—ç®¡ç†ï¼ˆå¦‚ELKï¼‰**
   - ç»Ÿä¸€æ”¶é›†å’Œåˆ†ææ—¥å¿—
   - æ”¯æŒå…¨æ–‡æœç´¢å’Œå¯è§†åŒ–
   - ä¾¿äºé—®é¢˜æ’æŸ¥å’Œç›‘æ§

---

## 7. ç›‘æ§å’Œå‘Šè­¦

### 7.1 å…³é”®æŒ‡æ ‡ç›‘æ§

#### 7.1.1 æœåŠ¡å¥åº·æŒ‡æ ‡

- HTTPè¯·æ±‚æˆåŠŸç‡
- å¹³å‡å“åº”æ—¶é—´
- å¹¶å‘è¿æ¥æ•°
- é”™è¯¯ç‡ï¼ˆæŒ‰é”™è¯¯ç ç»Ÿè®¡ï¼‰

#### 7.1.2 ä¸šåŠ¡æŒ‡æ ‡

- ASRè¯†åˆ«æˆåŠŸç‡
- TTSåˆæˆæˆåŠŸç‡
- å£°çº¹è®¤è¯é€šè¿‡ç‡
- å·¥å…·è°ƒç”¨æˆåŠŸç‡
- ä»»åŠ¡å®Œæˆç‡

#### 7.1.3 ç³»ç»ŸæŒ‡æ ‡

- CPUä½¿ç”¨ç‡
- å†…å­˜ä½¿ç”¨ç‡
- ç£ç›˜ä½¿ç”¨ç‡
- ç½‘ç»œæµé‡

### 7.2 å‘Šè­¦è§„åˆ™

**å»ºè®®å‘Šè­¦é˜ˆå€¼ï¼š**
- é”™è¯¯ç‡ > 5%ï¼šè­¦å‘Š
- é”™è¯¯ç‡ > 10%ï¼šä¸¥é‡
- å“åº”æ—¶é—´ > 5sï¼šè­¦å‘Š
- å“åº”æ—¶é—´ > 10sï¼šä¸¥é‡
- æœåŠ¡ä¸å¯ç”¨ï¼šä¸¥é‡

### 7.3 æ—¥å¿—ç›‘æ§å®ç°

**ç¤ºä¾‹ï¼šä½¿ç”¨æ—¥å¿—ç›‘æ§é”™è¯¯ç‡**
```python
# åœ¨æ—¥å¿—ä¸­è®°å½•å…³é”®æŒ‡æ ‡
logger.info(
    "è¯·æ±‚å¤„ç†å®Œæˆ",
    extra={
        "request_id": request_id,
        "status_code": status_code,
        "duration_ms": duration,
        "success": success
    }
)

# ç›‘æ§ç³»ç»Ÿå¯ä»¥ä»æ—¥å¿—ä¸­æå–è¿™äº›æŒ‡æ ‡
# å¹¶è®¡ç®—é”™è¯¯ç‡ã€å¹³å‡å“åº”æ—¶é—´ç­‰
```

---

## 8. å‚è€ƒèµ„æº

### 8.1 ç›¸å…³æ–‡æ¡£

- [ç³»ç»Ÿæ—¥å¿—è§„èŒƒåŠæœ€ä½³å®è·µ](https://xie.infoq.cn/article/c7e46aa4bd7de3edb855c1f29)
- [Python loggingå®˜æ–¹æ–‡æ¡£](https://docs.python.org/3/library/logging.html)
- [é˜¿é‡Œäº‘æ—¥å¿—æœåŠ¡](https://help.aliyun.com/zh/sls/)

### 8.2 å·¥å…·æ¨è

- **æ—¥å¿—æ”¶é›†**: ELK Stack (Elasticsearch, Logstash, Kibana)
- **æ—¥å¿—åˆ†æ**: Grafana Loki
- **æ—¥å¿—ç›‘æ§**: Prometheus + Grafana
- **æ—¥å¿—è½®è½¬**: logrotate (Linux)


